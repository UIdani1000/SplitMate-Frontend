<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Leaderboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/wallet.js"></script> 
    
    <script>
        // --- Tailwind Configuration (UI Theme) ---
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                background: "#10002b",
                card: { DEFAULT: "transparent", foreground: "hsl(210 40% 98%)" },
                primary: {
                  DEFAULT: "#c77dff", // Bright Electric Purple
                  active: "#7400b8", // Deep Purple for Button Fill
                  foreground: "hsl(210 40% 98%)",
                },
                secondary: {
                  DEFAULT: "#ff9e00", // Vibrant Orange
                  foreground: "hsl(210 40% 98%)",
                },
                border: "hsl(260 20% 25%)", 
                input: "hsl(260 20% 25%)",
                ring: "hsl(260 20% 25%)",
                foreground: "hsl(210 40% 98%)",
                muted: {
                  DEFAULT: "hsl(215 27.9% 16.3%)",
                  foreground: "hsl(215 14% 65%)",
                },
                rankGold: "#FFD700", // For Rank #1
                rankSilver: "#C0C0C0", // For Rank #2
                rankBronze: "#CD7F32", // For Rank #3
              },
            },
          },
        };
    </script>
    <style>
        /* Global Fade-In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom style for the progress bar background (for contrast) */
        .progress-bar-bg {
            background-color: hsl(260 20% 25%); /* Use the border color for the track */
            height: 8px;
            border-radius: 4px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: #c77dff; /* Primary color */
            height: 100%;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-background text-foreground">

    <div class="p-4 border-b border-border/50 flex items-center justify-between">
        <a href="index.html" class="text-2xl font-bold text-primary hover:text-secondary transition-colors">SplitMate</a>
        
        <nav class="hidden md:flex items-center gap-4 text-sm font-medium">
            <a href="index.html" class="text-muted-foreground hover:text-primary transition-colors">Dashboard</a> 
            <a href="create.html" class="text-muted-foreground hover:text-primary transition-colors">Create Bill</a>
            <a href="leaderboard.html" class="text-primary transition-colors">Leaderboard</a>
        </nav>
        
        <div class="flex items-center gap-4">
            <button 
                id="wallet-button" 
                onclick="window.userAddress ? window.disconnectWallet() : openConnectModal()" 
                class="text-primary-foreground font-semibold py-2 px-4 rounded-full transition-all hover:scale-[1.05]" 
                style="background-color: #7400b8;">
                Connect Wallet
            </button>
            <button id="menu-toggle" class="md:hidden text-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <nav id="mobile-menu" class="hidden md:hidden flex flex-col p-4 bg-background border-b border-border">
        <a href="index.html" class="py-2 text-muted-foreground hover:text-primary border-b border-border">Dashboard</a>
        <a href="create.html" class="py-2 text-muted-foreground hover:text-primary border-b border-border">Create Bill</a>
        <a href="leaderboard.html" class="py-2 text-primary">Leaderboard</a>
        <button 
            id="mobile-wallet-button" 
            onclick="window.userAddress ? window.disconnectWallet() : openConnectModal()" 
            class="mt-2 w-full text-left py-2 px-4 rounded-lg bg-primary text-background text-sm font-semibold hover:bg-primary-active transition duration-200">
            Connect Wallet
        </button>
    </nav>
    

    <div class="container px-4 py-8 max-w-5xl mx-auto fade-in">
        <h1 class="text-3xl font-bold mb-1">Reputation Leaderboard</h1>
        <p class="text-sm text-muted-foreground mb-8">Top payers who settle bills the fastest and most reliably.</p>

        <div class="bg-background border border-primary/50 rounded-2xl shadow-lg overflow-hidden">
            
            <div class="grid grid-cols-12 gap-4 p-4 text-sm font-semibold text-muted-foreground border-b border-border">
                <div class="col-span-1 text-center">RANK</div>
                <div class="col-span-4">PAYER / WALLET</div>
                <div class="col-span-3 text-right">SETTLED BILLS</div>
                <div class="col-span-4 text-right">REPUTATION SCORE</div>
            </div>

            <div id="leaderboard-list" class="flex items-center justify-center p-8 text-muted-foreground">
                Loading leaderboard data...
            </div>
            
        </div>
    </div>
    
    <div id="connect-wallet-modal" class="fixed inset-0 bg-background/90 backdrop-blur-sm z-50 hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-card/90 border border-primary p-6 rounded-xl shadow-2xl w-full max-w-sm relative">
            <button onclick="closeConnectModal()" class="absolute top-4 right-4 text-foreground hover:text-primary transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <h3 class="text-2xl font-bold text-primary mb-4">Connect Wallet</h3>
            <p class="text-sm text-muted-foreground mb-6">Choose your preferred network and wallet.</p>

            <div class="space-y-4">
                <button onclick="window.connectMetamaskWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="w-6 h-6 mr-3">
                    MetaMask (EVM)
                </button>
                <button onclick="window.connectStarknetWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://starkware.co/wp-content/uploads/2021/07/starknet-logo.svg" alt="Starknet" class="w-6 h-6 mr-3">
                    Starknet (ArgentX/Braavos)
                </button>
                <button onclick="window.connectXverseWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://www.xverse.app/img/logo.svg" alt="Xverse" class="w-6 h-6 mr-3">
                    Bitcoin / Sponsor
                </button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed inset-0 bg-background/90 backdrop-blur-sm z-[60] hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-card/90 border border-primary p-6 rounded-xl shadow-2xl w-full max-w-sm relative text-center">
            <h3 id="message-title" class="text-xl font-bold text-primary mb-3"></h3>
            <p id="message-content" class="text-sm text-muted-foreground mb-6"></p>
            <button onclick="closeMessageBox()" class="w-full py-2 bg-primary text-background font-semibold rounded-lg hover:bg-primary-active transition duration-200">
                OK
            </button>
        </div>
    </div>

    <script>
        // --- Wallet Connection Utilities (CRITICAL FIX) ---
        
        function formatAddress(address, chars = 6) {
            if (!address || address.length < chars * 2 + 3) return address;
            return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
        }

        // Must be defined locally to control the modal HTML
        function openConnectModal() {
            const modal = document.getElementById('connect-wallet-modal'); 
            if (modal) {
                 modal.classList.remove('hidden');
                 modal.classList.add('flex');
            }
        }

        function closeConnectModal() {
            const modal = document.getElementById('connect-wallet-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        // This function is called by wallet.js whenever the connection state changes
        window.loadPageContent = async function(address) { 
            const walletButton = document.getElementById('wallet-button'); 
            const mobileWalletButton = document.getElementById('mobile-wallet-button'); 
            const isConnected = !!window.userAddress; 

            if (isConnected) {
                const buttonText = `Disconnect (${formatAddress(window.userAddress, 4)})`;
                walletButton.textContent = buttonText;
                mobileWalletButton.textContent = buttonText;
                
                // Re-bind click to disconnect
                walletButton.onclick = window.disconnectWallet; 
                mobileWalletButton.onclick = window.disconnectWallet; 

                // Optionally, highlight the current user on the leaderboard
                // Rerender the list to ensure highlighting is applied
                if (window.leaderboardData && window.leaderboardData.length > 0) {
                    renderLeaderboardList(window.leaderboardData);
                }

            } else {
                // Not connected
                walletButton.textContent = 'Connect Wallet';
                mobileWalletButton.textContent = 'Connect Wallet';
                
                // Re-bind click to open modal
                walletButton.onclick = openConnectModal;
                mobileWalletButton.onclick = openConnectModal;
                
                 // Rerender to remove user highlight if disconnected
                 if (window.leaderboardData && window.leaderboardData.length > 0) {
                    renderLeaderboardList(window.leaderboardData);
                }
            }
        }

        // --- Message Box Utilities ---
        function showMessageBox(title, content) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }


        // --- Data Fetching Placeholder ---
        window.leaderboardData = []; // Global to store data for loadPageContent to use

        async function fetchLeaderboardData() {
            console.log("Fetching leaderboard data from contract...");
            
            // --- MOCK DATA --- 
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            return [
                { rank: 1, name: "Crypto King", address: "0x1A4B...C7D8", settledBills: 55, score: 98.50 },
                { rank: 2, name: "Wallet Warrior", address: "0x2D5E...F9A0", settledBills: 48, score: 95.25 },
                { rank: 3, name: "Split God", address: "0x3C6F...G1B2", settledBills: 41, score: 92.11 },
                { rank: 4, name: "Anon Payer", address: "0x4G7H...H3C4", settledBills: 33, score: 88.90 },
                { rank: 5, name: "FastSettler", address: "0x5H8I...I5D6", settledBills: 29, score: 85.70 },
            ];
            // --- END MOCK DATA ---
        }

        // --- Core Functions ---

        function getRankColor(rank) {
            switch (rank) {
                case 1:
                    return 'bg-rankGold/30 text-rankGold border-rankGold/50';
                case 2:
                    return 'bg-rankSilver/30 text-rankSilver border-rankSilver/50';
                case 3:
                    return 'bg-rankBronze/30 text-rankBronze border-rankBronze/50';
                default:
                    return 'bg-muted/50 text-muted-foreground border-border/50';
            }
        }
        
        function renderLeaderboardList(players) {
            const container = document.getElementById('leaderboard-list');
            container.innerHTML = ''; 

            if (players.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-8 text-muted-foreground">
                        No reputation data available. Start splitting bills to earn your score!
                    </div>
                `;
                return;
            }
            
            const currentUserAddress = window.userAddress ? window.userAddress.toLowerCase() : null;

            players.forEach(player => {
                const rankColor = getRankColor(player.rank);
                
                // Check for highlighting based on the connected wallet
                const isCurrentUser = currentUserAddress && player.address.toLowerCase() === currentUserAddress; 

                const rowClasses = isCurrentUser 
                    ? 'bg-primary/20 border-primary/50' 
                    : 'bg-background border-border/50 hover:bg-background/50';
                
                const scoreText = player.score.toFixed(2) + '%';
                const progressBarWidth = player.score; 

                const playerRow = `
                    <div class="grid grid-cols-12 gap-4 p-4 text-sm border-b transition-colors duration-300 ${rowClasses}">
                        
                        <div class="col-span-1 flex items-center justify-center">
                            <span class="font-bold w-6 h-6 flex items-center justify-center rounded-full text-xs border ${rankColor}">
                                #${player.rank}
                            </span>
                        </div>

                        <div class="col-span-4 flex flex-col justify-center">
                            <div class="font-semibold text-base ${isCurrentUser ? 'text-primary' : 'text-foreground'}">${player.name || 'Unknown Payer'}</div>
                            <div class="text-xs text-muted-foreground truncate">${formatAddress(player.address, 4)}</div>
                        </div>

                        <div class="col-span-3 flex items-center justify-end text-base font-semibold">${player.settledBills}</div>

                        <div class="col-span-4 flex flex-col justify-center items-end space-y-1">
                            <div class="text-base font-bold ${isCurrentUser ? 'text-primary' : 'text-foreground'}">${scoreText}</div>
                            <div class="progress-bar-bg w-full max-w-32">
                                <div class="progress-bar-fill" style="width: ${progressBarWidth}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', playerRow);
            });
        }
        
        function loadLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            container.innerHTML = '<div class="text-center p-8 text-primary font-semibold">Loading reputation scores...</div>';

            try {
                fetchLeaderboardData().then(data => {
                    window.leaderboardData = data; // Store globally
                    renderLeaderboardList(window.leaderboardData);
                    // Force a UI update after data is loaded
                    window.loadPageContent(window.userAddress); 
                }).catch(error => {
                    console.error("Failed to load leaderboard:", error);
                    container.innerHTML = `
                        <div class="text-center p-8 text-red-400">
                            Error loading data. Check console for details.
                        </div>
                    `;
                });

            } catch (error) {
                // Catches immediate sync errors
                console.error("Failed to initiate leaderboard load:", error);
            }
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            loadLeaderboard();
        });
        
        // Mobile Menu Toggle Script
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });
    </script>
</body>
</html>