<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Decentralized Bill Splitting</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Apply Inter font family and custom scrollbar styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #10002b; }
        ::-webkit-scrollbar-thumb { background: #7400b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c77dff; }
    </style>
    
    <script type="module">
        
        // ====================================================================
        // --- 0. ES MODULE IMPORTS (CRITICAL FIX FOR STARNKENET) ---
        // ====================================================================
        
        // These imports fix the SyntaxError and ReferenceError issues
        import { Contract, cairo, shortString } from 'https://cdn.jsdelivr.net/npm/starknet@latest/dist/starknet.js';
        import { getStarknet } from 'https://cdn.jsdelivr.net/npm/@starknet-io/get-starknet@latest/dist/index.js';


        // ====================================================================
        // --- 1. STARKNET CONFIGURATION & GLOBAL STATE ---
        // ====================================================================

        // >>> ⚠️ IMPORTANT: REPLACE THESE WITH YOUR DEPLOYED CONTRACT DETAILS ⚠️ <<<
        const SPLITMATE_CONTRACT_ADDRESS = "0xYOUR_SPLITMATE_CONTRACT_ADDRESS_HERE";
        const ETH_ERC20_ADDRESS = "0x049d36570d4e46f48e99674bd3fcc84644ddd6b96f7c741b1562b82f9e004dc7"; 
        const ETH_DECIMALS = 18;
        
        // Minimal ABI (Must match your contract)
        const SPLITMATE_ABI = [
            { type: "function", name: "create_bill", inputs: [{ name: "bill_id", type: "felt" }, { name: "name", type: "felt" }, { name: "total_amount", type: "u256" }, { name: "payer", type: "ContractAddress" }, { name: "participants", type: "ContractAddress*" }, { name: "shares", type: "u256*" }], outputs: [], state_mutability: "external" },
            { type: "function", name: "settle_share", inputs: [{ name: "bill_id", type: "felt" }], outputs: [], state_mutability: "external" },
            { type: "function", name: "get_user_bills", inputs: [{ name: "user_address", type: "ContractAddress" }], outputs: [{ name: "bills", type: "BillStruct*" }], state_mutability: "view" },
            { type: "function", name: "approve", inputs: [{ name: "spender", type: "ContractAddress" }, { name: "amount", type: "u256" }], outputs: [{ name: "success", type: "bool" }], state_mutability: "external" }
        ];

        // Global State (exposed to window for UI functions)
        window.starknetAccount = null; 
        window.starknetProvider = null; 
        window.splitMateContract = null; 
        window.userAddress = null; 
        window.cairo = cairo;         // Expose starknet utilities to window
        window.shortString = shortString; // Expose starknet utilities to window

        // Utility functions
        function toStarknetU256(amount, decimals = ETH_DECIMALS) {
            const multiplier = 10n ** BigInt(decimals);
            const value = BigInt(Math.floor(amount * (Number(multiplier))))
            return cairo.uint256(value.toString());
        }
        function fromStarknetU256(u256, decimals = ETH_DECIMALS) {
            const value = BigInt(u256.low) + (BigInt(u256.high) << 128n);
            const divisor = 10 ** decimals;
            return Number(value) / divisor;
        }


        // ====================================================================
        // --- 2. WALLET CONNECTION LOGIC (EXPOSED TO WINDOW) ---
        // ====================================================================

        window.connectWallet = async function() {
            try {
                const starknet = getStarknet(); // Uses imported function
                if (!starknet) {
                    window.showMessageBox("Wallet Required", "Please install ArgentX or Braavos.", () => {
                        window.open("https://www.starknet.io/en/ecosystem/wallets", "_blank");
                    });
                    return false;
                }

                const enabled = await starknet.enable({ starknetVersion: "v5" });
                
                if (enabled && enabled.account) {
                    window.starknetAccount = enabled.account;
                    window.userAddress = window.starknetAccount.address;
                    window.starknetProvider = window.starknetAccount.provider;
                    
                    window.splitMateContract = new Contract( // Uses imported class
                        SPLITMATE_ABI, 
                        SPLITMATE_CONTRACT_ADDRESS, 
                        window.starknetAccount 
                    );

                    window.updateWalletUI(); 
                    return true;
                }
            } catch (error) {
                console.error("Starknet wallet connection failed:", error);
                window.showMessageBox("Connection Error", `Failed to connect: ${error.message || "User rejected connection."}`);
            }
            return false;
        }

        window.disconnectWallet = function() {
            window.starknetAccount = null;
            window.userAddress = null;
            window.starknetProvider = null;
            window.splitMateContract = null;
            window.updateWalletUI(); 
            window.navigateTo('dashboard');
        }
        
        // Placeholder functions for the wallet picker UI
        window.connectMetamaskWallet = function() { window.showMessageBox("Connect Wallet", "Metamask is for Ethereum/EVM. SplitMate uses Starknet. Please use ArgentX or Braavos.", window.connectWallet); }
        window.connectXverseWallet = function() { window.showMessageBox("Connect Wallet", "Xverse is for Bitcoin/Stacks. SplitMate uses Starknet. Please use ArgentX or Braavos.", window.connectWallet); }


        // ====================================================================
        // --- 3. CONTRACT INTERACTION (CRUD STUBS) ---
        // ====================================================================
        
        // Note: These need your contract implementation logic.
        window.sendBillToContract = async function(formData, shares) {
            if (!window.starknetAccount) throw new Error("Wallet not connected.");
            return { transaction_hash: "0xUNIMPLEMENTED_TX_HASH" };
        }

        window.payBill = async function(billId, amountToPay) {
            if (!window.starknetAccount) throw new Error("Wallet not connected.");
            return { transaction_hash: "0xUNIMPLEMENTED_TX_HASH" };
        }

        window.fetchUserBills = async function(userAddress) {
            if (!window.splitMateContract) return []; 
            try {
                const result = await window.splitMateContract.get_user_bills(userAddress);
                
                // MOCK DATA STRUCTURE FOR UI (REPLACE WITH REAL PARSING)
                return [{
                    id: 1, name: "Mock Dinner", totalAmount: 50.00, payer: userAddress, isSettled: false, 
                    shares: [{address: "0xmockParticipant", amount: 25.00}, {address: userAddress, amount: 25.00}]
                }];

            } catch (error) {
                console.error("Error fetching bills. Returning mock data.", error);
                return [];
            }
        }

        window.fetchLeaderboard = async function() {
            // MOCK DATA
            const userAddress = window.userAddress || "0xUnconnectedUser";
            return [
                { address: "0x05f8...1234", score: 9.8, settledRate: 0.98, totalBills: 25 },
                { address: userAddress, score: 9.5, settledRate: 0.95, totalBills: 12 },
                { address: "0x0a1c...5678", score: 9.0, settledRate: 0.90, totalBills: 40 },
            ];
        }


        // ====================================================================
        // --- 4. TAILWIND CONFIGURATION & UI LOGIC (From index.html) ---
        // ====================================================================

        // Fix: Use a self-executing function or place configuration before other logic
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                background: "#10002b",
                card: { DEFAULT: "rgba(255, 255, 255, 0.05)", foreground: "hsl(210 40% 98%)" },
                primary: { DEFAULT: "#c77dff", active: "#7400b8", foreground: "hsl(210 40% 98%)" },
                secondary: { DEFAULT: "#ff9e00", foreground: "hsl(210 40% 98%)" },
                border: "hsl(260 20% 25%)", input: "hsl(260 20% 25%)", ring: "hsl(260 20% 25%)",
                foreground: "hsl(210 40% 98%)",
                muted: { DEFAULT: "hsl(215 20% 60%)", foreground: "hsl(215 20% 80%)" },
              },
              borderRadius: { xl: "1.25rem", lg: "1rem" }
            }
          }
        }
        
        // Expose UI functions globally as well
        window.showMessageBox = function(title, content, onOk = null) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            const okButton = document.querySelector('#message-box button');
            
            okButton.onclick = null; 
            okButton.onclick = () => {
                window.closeMessageBox();
                if (typeof onOk === 'function') {
                    onOk();
                }
            };
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        window.closeMessageBox = function() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }

        window.updateWalletUI = function() {
            const btn = document.getElementById('connect-wallet-btn');
            const mobileBtn = document.getElementById('mobile-connect-btn');
            
            if (window.userAddress && typeof window.userAddress === 'string') {
                const shortAddress = window.userAddress.substring(0, 6) + '...' + window.userAddress.slice(-4);
                
                btn.textContent = shortAddress;
                btn.classList.remove('bg-primary', 'hover:bg-primary/90');
                btn.classList.add('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono'); 
                
                mobileBtn.textContent = shortAddress;
                mobileBtn.classList.remove('text-primary', 'bg-primary/20');
                mobileBtn.classList.add('bg-green-600/20', 'text-green-400');
            } else {
                btn.textContent = "Connect Wallet";
                btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono');
                btn.classList.add('bg-primary', 'hover:bg-primary/90');

                mobileBtn.textContent = "Connect Wallet";
                mobileBtn.classList.remove('bg-green-600/20', 'text-green-400');
                mobileBtn.classList.add('text-primary', 'bg-primary/20');
            }
            window.loadDashboardContent();
            window.loadLeaderboard(); 
        }
        
        const VIEWS = ['dashboard', 'create', 'leaderboard'];
        
	    window.navigateTo = function(viewId) {
            if (!VIEWS.includes(viewId)) return;

            VIEWS.forEach(id => { document.getElementById(id + '-view')?.classList.add('hidden'); });
            document.getElementById(viewId + '-view')?.classList.remove('hidden');

            const titleMap = { 'dashboard': 'Dashboard', 'create': 'Create Bill', 'leaderboard': 'Reputation Leaderboard' };
            document.getElementById('main-header-title').textContent = titleMap[viewId] || 'SplitMate';

            if (viewId === 'dashboard') window.loadDashboardContent(); 
            else if (viewId === 'leaderboard') window.loadLeaderboard();

            document.getElementById('mobile-menu').classList.add('hidden');
            
            window.updateWalletUI(); 
        }

        // Rest of the UI functions (loadDashboardContent, toggleSplit, etc.) must also be attached to window
        window.loadDashboardContent = async function() { /* ... implementation moved from original index.html ... */ };
        window.loadLeaderboard = async function() { /* ... implementation moved from original index.html ... */ };
        window.toggleSplit = function(type) { /* ... implementation moved from original index.html ... */ };
        window.updateParticipants = function(count) { /* ... implementation moved from original index.html ... */ };
        window.changeParticipantCount = function(delta) { /* ... implementation moved from original index.html ... */ };
        window.submitBill = async function() { /* ... implementation moved from original index.html ... */ };

        // ====================================================================
        // --- 5. INITIALIZATION ---
        // ====================================================================

        function setupInitialUI() {
            // Re-expose all necessary functions to the window object to prevent errors
            // Note: In a module, this should ideally be done with a single function,
            // but for quick fix, we ensure the HTML's inline calls work.
            window.loadDashboardContent = window.loadDashboardContent;
            window.loadLeaderboard = window.loadLeaderboard;
            window.toggleSplit = window.toggleSplit;
            window.updateParticipants = window.updateParticipants;
            window.changeParticipantCount = window.changeParticipantCount;
            window.submitBill = window.submitBill;


            document.getElementById('bill-form').addEventListener('submit', function(e) { 
                e.preventDefault(); 
                window.submitBill(); 
            });

            document.getElementById('menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            window.toggleSplit('even'); 
            window.updateParticipants(0); 
            window.navigateTo('dashboard');
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupInitialUI();
            
            // Auto-connect attempt
            const starknet = getStarknet(); 
            if (starknet && starknet.isConnected) {
                window.connectWallet().catch(console.error);
            }
        });
    </script>
    
</head>
<body class="bg-background min-h-screen text-foreground antialiased overflow-x-hidden">

    <div id="message-box" class="hidden fixed inset-0 z-50 bg-background/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#1a0035] border border-primary/50 rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="message-title" class="text-xl font-bold mb-2 text-primary">Notification</h3>
            <p id="message-content" class="text-muted mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeMessageBox()" class="px-6 py-2 bg-primary/70 rounded-lg text-white font-semibold hover:bg-primary transition duration-200 shadow-lg">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <nav class="sticky top-0 z-40 bg-background/90 backdrop-blur-md border-b border-border shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-3xl font-extrabold text-primary tracking-wider">Split<span class="text-secondary">Mate</span></span>
                </div>
                
                <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                    <a href="#" onclick="navigateTo('dashboard')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Dashboard</a>
                    <a href="#" onclick="navigateTo('create')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Create Bill</a>
                    <a href="#" onclick="navigateTo('leaderboard')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Leaderboard</a>
                </div>
                
                <div class="hidden sm:block">
                    <button id="connect-wallet-btn" onclick="window.connectWallet()" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-md shadow-primary/30">
    Connect Wallet
</button>
                </div>

                <div class="sm:hidden flex items-center">
                    <button id="menu-toggle" type="button" class="inline-flex items-center justify-center p-2 rounded-lg text-primary hover:text-white hover:bg-primary/20 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary/50" aria-controls="mobile-menu" aria-expanded="false">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#" onclick="navigateTo('dashboard')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Dashboard</a>
                <a href="#" onclick="navigateTo('create')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Create Bill</a>
                <a href="#" onclick="navigateTo('leaderboard')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Leaderboard</a>
                <button id="mobile-connect-btn" onclick="window.connectWallet()" class="w-full text-left px-3 py-2 bg-primary/20 rounded-lg text-base font-medium text-primary hover:bg-primary/40 transition">
    Connect Wallet
</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <h1 id="main-header-title" class="text-3xl sm:text-4xl font-extrabold text-foreground mb-8 border-b-2 border-primary/20 pb-2">Dashboard</h1>

        <section id="dashboard-view" class="space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Total Owed To You</h2>
                    <p id="total-owed" class="text-4xl font-extrabold text-green-400">$0.00</p>
                </div>
                
                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Total You Owe</h2>
                    <p id="total-due" class="text-4xl font-extrabold text-red-400">$0.00</p>
                </div>

                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Net Balance</h2>
                    <p id="net-balance" class="text-4xl font-extrabold text-foreground">$0.00</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-primary mb-4">Your Recent Bills</h2>
                <div id="bill-list" class="space-y-4">
                    <div class="text-center p-8 text-muted">Please connect your wallet...</div>
                </div>
            </div>

            <div class="pt-4 text-center">
                <button onclick="navigateTo('create')" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-xl transition duration-300 text-lg shadow-lg shadow-primary/30">
                    Split a New Bill
                </button>
            </div>

        </section>

        <section id="create-view" class="hidden">
            <div class="max-w-2xl mx-auto bg-card p-6 sm:p-8 rounded-xl border border-border shadow-2xl">
                <form id="bill-form" class="space-y-6">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="bill-name" class="block text-sm font-medium text-muted mb-2">Bill Name (e.g., Dinner, Rent)</label>
                            <input type="text" id="bill-name" name="bill-name" required placeholder="Enter bill name"
                                   class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full"
                            >
                        </div>
                        <div>
                            <label for="bill-amount" class="block text-sm font-medium text-muted mb-2">Total Amount (USDC/ETH)</label>
                            <input type="number" id="bill-amount" name="bill-amount" required step="0.01" min="0.01" placeholder="100.00"
                                   class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full"
                            >
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-muted mb-3">Split Type</label>
                        <input type="hidden" id="split-type-input" value="even">
                        <div class="flex space-x-4">
                            <button type="button" id="split-type-even" onclick="window.toggleSplit('even')"
                                    class="flex-1 px-4 py-3 rounded-xl border border-primary/50 text-foreground font-semibold transition duration-200 bg-primary/50 hover:bg-primary/20">
                                Evenly
                            </button>
                            <button type="button" id="split-type-manual" onclick="window.toggleSplit('manual')"
                                    class="flex-1 px-4 py-3 rounded-xl border border-primary/50 text-foreground font-semibold transition duration-200 hover:bg-primary/20">
                                Manual Shares
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-muted mb-3">Number of Participants (excluding Payer)</label>
                        
                        <div class="flex items-center space-x-4 bg-input/50 p-3 rounded-xl border border-border">
                            <button type="button" onclick="window.changeParticipantCount(-1)" 
                                    class="w-10 h-10 bg-primary/20 text-primary rounded-lg text-2xl font-bold hover:bg-primary/40 transition duration-200">
                                &minus;
                            </button>
                            <span id="participant-count-display" class="w-16 text-center text-foreground bg-transparent text-xl font-bold border-none">0</span>
                            <input type="hidden" id="participant-count" name="participant-count" value="0" min="0" readonly>
                            <button type="button" onclick="window.changeParticipantCount(1)" 
                                    class="w-10 h-10 bg-primary/20 text-primary rounded-lg text-2xl font-bold hover:bg-primary/40 transition duration-200">
                                &plus;
                            </button>
                        </div>
                    </div>

                    <div id="manual-split-container" class="space-y-4 hidden pt-4 border-t border-border mt-6">
                        <h3 class="text-xl font-bold text-primary">Participant Details</h3>
                        <div id="participants-list">
                            </div>
                        <p class="text-xs text-muted">For Manual Split, ensure the sum of all shares (including the Payer's calculated share) equals the 'Total Amount'.</p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-bold py-3 rounded-xl transition duration-300 text-lg shadow-lg shadow-secondary/30">
                        Broadcast Bill to SplitMate
                    </button>
                </form>
            </div>
        </section>

        <section id="leaderboard-view" class="hidden">
            <div class="max-w-3xl mx-auto">
                <div class="bg-card p-6 rounded-xl border border-border shadow-2xl mb-6">
                    <p class="text-muted text-center">
                        The SplitMate Leaderboard ranks users based on their on-chain bill settlement history. Higher reputation scores indicate a greater commitment to prompt payments.
                    </p>
                </div>
                
                <div class="mb-4 flex justify-between items-center text-sm font-semibold text-muted border-b border-border pb-2">
                    <span class="w-1/2">Rank / Address</span>
                    <span class="text-right">Reputation Score / Settled Rate</span>
                </div>

                <div id="leaderboard-list" class="space-y-3">
                    <div class="text-center p-8 text-muted">Loading leaderboard...</div>
                </div>
            </div>
        </section>
        
    </main>
    
</body>
</html>