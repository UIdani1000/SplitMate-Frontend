<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Decentralized Bill Splitting</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
        tailwind.config = {
          darkMode: 'class', 
          theme: {
            extend: {
              colors: {
                // Simplified core color palette
                background: "#10002b",
                card: "rgba(255, 255, 255, 0.05)",
                primary: "#c77dff", 
                secondary: "#ff9e00",
                foreground: "hsl(210 40% 98%)",
                input: "#21004e",
                border: "rgba(255, 255, 255, 0.1)"
              },
              borderRadius: { xl: "1.25rem", lg: "1rem" }
            }
          }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #10002b; }
        ::-webkit-scrollbar-thumb { background: #3b007d; border-radius: 4px; }
        .bg-gradient-header {
            background-image: linear-gradient(to right, #21004e, #10002b);
        }
    </style>

</head>
<body class="bg-background text-foreground min-h-screen">
    <header class="bg-gradient-header p-4 shadow-xl sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-primary">SplitMate <span class="text-secondary text-base">V2</span></h1>
            <nav>
                <a href="#dashboard" class="nav-link text-primary font-semibold mx-3 hover:text-secondary transition duration-300">Dashboard</a>
                <a href="#create" class="nav-link text-foreground font-semibold mx-3 hover:text-secondary transition duration-300">Create Bill</a>
                <a href="#profile" class="nav-link text-foreground font-semibold mx-3 hover:text-secondary transition duration-300">Profile / ID</a>
            </nav>
            <button id="connectWalletBtn" class="bg-primary text-background font-bold py-2 px-4 rounded-lg hover:bg-primary/80 transition duration-300">
                Connect Wallet
            </button>
            <div id="walletInfo" class="hidden flex items-center bg-card rounded-lg px-3 py-1 border border-border">
                <span id="mateIdDisplay" class="text-sm font-semibold text-secondary mr-3 hover:underline cursor-pointer" title="Manage your unique .mate ID">
                    --.--mate
                </span>
                <span id="accountAddress" class="text-sm font-mono mr-2"></span>
                <span id="networkId" class="text-xs text-secondary bg-primary/20 rounded-full px-2 py-0.5"></span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="statusMessageContainer" class="fixed top-20 right-4 w-full max-w-sm z-50">
            </div>

        <section id="dashboard" class="page-section" data-section="dashboard">
            <h2 class="text-4xl font-extrabold text-white mb-6 border-b border-primary/30 pb-2">Your Bills Dashboard</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg">
                    <p class="text-sm text-primary/70 mb-1">Total Due to You</p>
                    <p id="totalDueToYou" class="text-3xl font-bold text-primary">0.00 ETH</p>
                </div>
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg">
                    <p class="text-sm text-secondary/70 mb-1">Total You Owe</p>
                    <p id="totalYouOwe" class="text-3xl font-bold text-secondary">0.00 ETH</p>
                </div>
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg">
                    <p class="text-sm text-white/70 mb-1">Net Balance</p>
                    <p id="netBalance" class="text-3xl font-bold text-white">0.00 ETH</p>
                </div>
            </div>

            <h3 class="text-2xl font-semibold text-white mb-4">Bills You Are Involved In</h3>
            <div id="billsList" class="space-y-4">
                <p id="loadingMessage" class="text-center text-primary/50">Connect your wallet to view your bills.</p>
            </div>
        </section>
        
        <section id="profile" class="page-section hidden" data-section="profile">
            <h2 class="text-4xl font-extrabold text-white mb-6 border-b border-primary/30 pb-2">Your Profile & Unique ID</h2>
            
            <div id="addressBookManager" class="bg-card p-6 rounded-xl border border-border shadow-lg">
                <h3 class="text-xl font-semibold text-white border-b border-border pb-2 mb-3">Local Address Book Manager</h3>
                
                <div id="currentIdStatus" class="p-3 mb-4 rounded-lg bg-primary/10 text-primary font-medium flex justify-between items-center">
                    <span id="currentIdText"></span>
                    <button type="button" id="clearMateIdBtn" class="bg-red-500/20 text-red-500 font-bold py-1 px-3 rounded-lg hover:bg-red-500/30 transition duration-300 text-sm hidden">Clear My ID</button>
                </div>

                <p class="text-sm text-foreground/70 mb-4">
                    Register your **unique SplitMate ID** (e.g., `david.mate`) by entering it below and linking it to your connected wallet address. 
                    You can then use this ID in any address field across the app.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="contactUsername" placeholder="Username (e.g., Alice or david.mate)" class="p-3 rounded-lg bg-input border border-border text-foreground"/>
                    <input type="text" id="contactAddress" placeholder="0x... or ENS name (Your Wallet Address for ID)" class="p-3 rounded-lg bg-input border border-border text-foreground"/>
                    <button type="button" id="saveContactBtn" class="bg-secondary text-background font-bold py-3 rounded-lg hover:bg-secondary/80 transition duration-300">Save Contact</button>
                </div>
                
                <h4 class="text-lg font-semibold text-white mt-6 mb-3 border-b border-border pb-1">Saved Contacts</h4>
                <div class="mt-4 max-h-60 overflow-y-auto p-2 bg-input rounded-lg border border-border">
                    <ul id="addressBookList" class="text-sm space-y-1">
                        </ul>
                </div>
            </div>
        </section>

        <section id="create" class="page-section hidden" data-section="create">
            <h2 class="text-4xl font-extrabold text-white mb-6 border-b border-primary/30 pb-2">Create New Bill</h2>
            
            <form id="billForm" class="space-y-6">
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg space-y-4">
                    <h3 class="text-2xl font-semibold text-white mb-3 border-b border-border pb-2">Bill Information</h3>
                    
                    <div>
                        <label for="bill-description" class="block text-sm font-medium text-foreground mb-1">Description</label>
                        <input type="text" id="bill-description" required
                            class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50" 
                            placeholder="Dinner at Joe's, Rent for October, etc."/>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="total-amount" class="block text-sm font-medium text-foreground mb-1">Total Bill Amount (USD/Fiat Value)</label>
                            <input type="number" id="total-amount" step="0.01" required
                                class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50" 
                                placeholder="100.00" min="0.01"/>
                        </div>
                        <div>
                            <label for="merchant-address" class="block text-sm font-medium text-foreground mb-1">Merchant/Settlement Address</label>
                            <input type="text" id="merchant-address" required
                                class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50" 
                                placeholder="0x..., ENS name, or your ID (e.g., david.mate)" />
                            <p class="text-xs text-primary/70 mt-1">This is where the final, collected funds will be sent upon completion. Use the Profile page to manage your IDs.</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-card p-6 rounded-xl border border-border shadow-lg space-y-4">
                    <h3 class="text-2xl font-semibold text-white mb-3 border-b border-border pb-2">Splitting Method</h3>
                    
                    <div>
                        <label for="split-type" class="block text-sm font-medium text-foreground mb-1">Choose Split Type</label>
                        <select id="split-type" required
                            class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50">
                            <option value="equal">Equal Split (Recommended)</option>
                            <option value="manual">Manual Amounts</option>
                        </select>
                    </div>

                    <div id="participantContainer" class="space-y-3">
                        </div>

                    <button type="button" id="addParticipantBtn" class="w-full bg-secondary/20 text-secondary font-semibold py-3 rounded-lg hover:bg-secondary/30 transition duration-300 mt-2">
                        + Add Person
                    </button>
                    
                    <div id="splitSummary" class="mt-4 p-3 bg-primary/10 rounded-lg text-primary text-sm font-medium">
                        Summary: Enter Bill Amount and Participants to see the split.
                    </div>
                </div>

                <button type="submit" id="submitBillBtn" class="w-full bg-primary text-background font-extrabold text-lg py-4 rounded-xl hover:bg-primary/80 transition duration-300" disabled>
                    Connect Wallet to Create Bill
                </button>
            </form>
        </section>
    </main>

    <script>
        // --- CONSTANTS ---
        let web3;
        let currentAccount;
        let splitMateContract;
        let participantCount = 0; 

        // <<< CONTRACT DETAILS >>>: Updated to SplitMateV2 contract address
        const SPLITMATE_CONTRACT_ADDRESS = "0x195d869a9eF883bA3a827A99e3B36EcCFa9D1DF8"; 
        const CONTRACT_ABI = [
            // ... (Your full ABI JSON goes here) ...
            { "inputs": [{ "internalType": "address[]", "name": "_participants", "type": "address[]" }, { "internalType": "uint256", "name": "_totalWei", "type": "uint256" }, { "internalType": "uint256[]", "name": "_amountsWei", "type": "uint256[]" }, { "internalType": "address", "name": "_merchantAddress", "type": "address" }, { "internalType": "string", "name": "_description", "type": "string" }], "name": "createBill", "outputs": [], "stateMutability": "payable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_billId", "type": "uint256" }], "name": "payShare", "outputs": [], "stateMutability": "payable", "type": "function" },
            // ... (rest of the ABI) ...
        ];

        // --- CUSTOM ID CONSTANTS ---
        const MATE_SUFFIX = '.mate';
        const MATE_ID_KEY = 'splitmate_mate_id'; 

        // --- DOM ELEMENTS (FIXED: Added balance elements) ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const accountAddress = document.getElementById('accountAddress');
        const networkId = document.getElementById('networkId');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const participantContainer = document.getElementById('participantContainer');
        const splitTypeSelect = document.getElementById('split-type');
        const totalAmountInput = document.getElementById('total-amount');
        const billForm = document.getElementById('billForm');
        const submitBillBtn = document.getElementById('submitBillBtn');
        const splitSummary = document.getElementById('splitSummary');
        const statusMessageContainer = document.getElementById('statusMessageContainer');
        const billsList = document.getElementById('billsList');
        const navLinks = document.querySelectorAll('.nav-link');
        const mateIdDisplay = document.getElementById('mateIdDisplay'); 
        const currentIdStatus = document.getElementById('currentIdStatus'); 
        const currentIdText = document.getElementById('currentIdText'); 
        const clearMateIdBtn = document.getElementById('clearMateIdBtn'); 
        
        // Dashboard Balance Elements
        const totalDueToYouEl = document.getElementById('totalDueToYou');
        const totalYouOweEl = document.getElementById('totalYouOwe');
        const netBalanceEl = document.getElementById('netBalance');

        // Address Book Manager Elements
        const addressBookManager = document.getElementById('addressBookManager');
        const saveContactBtn = document.getElementById('saveContactBtn');
        const contactUsernameInput = document.getElementById('contactUsername');
        const contactAddressInput = document.getElementById('contactAddress');
        const addressBookList = document.getElementById('addressBookList');
        
        // --- LOCAL STORAGE / ADDRESS BOOK LOGIC ---
        let addressBook = {};
        const ADDRESS_BOOK_KEY = 'splitmate_address_book';
        const ADDRESS_REGEX = /^0x[a-fA-F0-9]{40}$/;

        function loadAddressBook() {
            const stored = localStorage.getItem(ADDRESS_BOOK_KEY);
            addressBook = stored ? JSON.parse(stored) : {};
            
            // If connected, ensure 'me' alias and 'mate' ID are in the in-memory book
            if (currentAccount) {
                // 1. Ensure 'me' alias is set
                addressBook['me'] = currentAccount;

                // 2. Load the user's specific .mate ID
                const savedMateId = localStorage.getItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`);
                if (savedMateId) {
                    addressBook[savedMateId] = currentAccount;
                    updateMateIdUI(savedMateId);
                } else {
                    updateMateIdUI(null);
                }
            } else {
                // If disconnected, clean up internal state
                delete addressBook['me'];
                updateMateIdUI(null);
            }
            
            // DEMO: Pre-populate other contacts
            if (!addressBook['alice']) {
                addressBook['alice'] = '0xabcdeF0123456789abcdeF0123456789abcdeF01';
            }

            renderAddressBookList();
        }

        function renderAddressBookList() {
            addressBookList.innerHTML = '';
            const contacts = Object.entries(addressBook);
            
            // Filter out 'me' if not connected, but keep it at the top
            const displayContacts = contacts.filter(([username]) => username !== 'me' || currentAccount);

            if (displayContacts.length === 0) {
                addressBookList.innerHTML = '<li class="text-center text-primary/50 py-2">No local contacts saved.</li>';
                return;
            }

            // Sort 'me' and '.mate' IDs to the top
            displayContacts.sort(([a], [b]) => {
                if (a === 'me') return -1;
                if (b === 'me') return 1;
                if (a.endsWith(MATE_SUFFIX) && currentAccount) return -1;
                if (b.endsWith(MATE_SUFFIX) && currentAccount) return 1;
                return a.localeCompare(b);
            });

            displayContacts.forEach(([username, address]) => {
                const isMe = username === 'me';
                const isMateId = username.endsWith(MATE_SUFFIX) && address.toLowerCase() === currentAccount.toLowerCase();
                const li = document.createElement('li');
                li.className = `flex justify-between items-center py-1 px-2 border-b border-border/50 last:border-b-0 ${isMe || isMateId ? 'bg-primary/10 font-bold' : ''}`;
                li.innerHTML = `
                    <span class="text-primary">${username} ${isMe ? '(Your Alias)' : isMateId ? '(Your ID)' : ''}</span>
                    <span class="font-mono text-xs text-foreground/70">${address.slice(0, 6)}...${address.slice(-4)}</span>
                `;
                addressBookList.appendChild(li);
            });
        }
        
        async function saveContactToAddressBook() {
            const username = contactUsernameInput.value.trim().toLowerCase();
            const addressOrName = contactAddressInput.value.trim();

            if (!username || !addressOrName) {
                showStatusMessage("Username and Address/ENS cannot be empty.", 'error');
                return;
            }
            if (!currentAccount) {
                showStatusMessage("Please connect your wallet to save contacts.", 'error');
                return;
            }

            let resolvedAddress;
            // 1. RESOLVE TARGET ADDRESS
            if (addressOrName.toLowerCase().endsWith('.eth') && web3) {
                try {
                    resolvedAddress = await web3.eth.ens.getAddress(addressOrName);
                    if (!resolvedAddress || resolvedAddress === '0x0000000000000000000000000000000000000000') {
                         showStatusMessage(`ENS name ${addressOrName} did not resolve to a valid address.`, 'error');
                         return;
                    }
                } catch (e) {
                    showStatusMessage(`Failed to resolve ENS name ${addressOrName}.`, 'error');
                    return;
                }
            } else if (ADDRESS_REGEX.test(addressOrName)) {
                resolvedAddress = addressOrName;
            } else {
                showStatusMessage("Address must be a valid 0x address or a resolvable ENS name.", 'error');
                return;
            }

            // 2. CHECK FOR UNIQUE .MATE ID REGISTRATION
            if (username.endsWith(MATE_SUFFIX)) {
                // Must be registering their own ID
                if (resolvedAddress.toLowerCase() !== currentAccount.toLowerCase()) {
                    showStatusMessage(`To register a **${MATE_SUFFIX}** ID, the address must be your connected wallet.`, 'error');
                    return;
                }

                // Check if this user already has a different .mate ID saved
                const existingMateId = localStorage.getItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`);
                if (existingMateId && existingMateId !== username) {
                    // Remove old ID from local storage and address book
                    localStorage.removeItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`);
                    delete addressBook[existingMateId]; 
                     showStatusMessage(`Your old ID **${existingMateId}** has been cleared. Registering **${username}**`, 'alert');
                }

                // Save the unique ID reference in localStorage (keyed by wallet)
                localStorage.setItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`, username);
                updateMateIdUI(username);
            }
            
            // 3. SAVE TO ADDRESS BOOK (For Lookup)
            if (addressBook[username] && addressBook[username].toLowerCase() !== resolvedAddress.toLowerCase()) {
                showStatusMessage(`Username **${username}** already exists and is pointing to a different address. Overwriting.`, 'alert');
            }

            addressBook[username] = resolvedAddress;
            localStorage.setItem(ADDRESS_BOOK_KEY, JSON.stringify(addressBook));
            
            showStatusMessage(`Contact **${username}** saved successfully!`, 'success');
            contactUsernameInput.value = '';
            contactAddressInput.value = '';
            loadAddressBook(); // Renders the updated list
        }

        // --- NEW FUNCTION: CLEAR MATE ID ---
        function clearMateId() {
            if (!currentAccount) return;
            const existingMateId = localStorage.getItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`);
            
            if (existingMateId) {
                // 1. Remove from localStorage
                localStorage.removeItem(`${MATE_ID_KEY}_${currentAccount.toLowerCase()}`);
                
                // 2. Remove from the in-memory address book
                delete addressBook[existingMateId];

                // 3. Save the pruned address book to localStorage
                localStorage.setItem(ADDRESS_BOOK_KEY, JSON.stringify(addressBook));
                
                // 4. Update UI
                updateMateIdUI(null);
                loadAddressBook();
                showStatusMessage(`Your SplitMate ID **${existingMateId}** has been successfully cleared. You can now register a new one.`, 'success');
            } else {
                 showStatusMessage(`No SplitMate ID is currently registered for this wallet.`, 'info');
            }
        }
        // ------------------------------------


        // --- UTILITY AND UI FUNCTIONS ---
        function updateMateIdUI(mateId) {
            if (mateId && mateId !== '--.--mate') {
                mateIdDisplay.textContent = mateId;
                mateIdDisplay.classList.remove('text-secondary');
                mateIdDisplay.classList.add('text-primary');
                // Update Profile section
                currentIdText.innerHTML = `✅ Your registered SplitMate ID is: <span class="font-bold">${mateId}</span>. Use it in any address field.`;
                clearMateIdBtn.classList.remove('hidden');
            } else {
                mateIdDisplay.textContent = '--.--mate (Click to Register)';
                mateIdDisplay.classList.remove('text-primary');
                mateIdDisplay.classList.add('text-secondary');
                 // Update Profile section
                currentIdText.innerHTML = `🔔 You have not registered a SplitMate ID. Register one below to use a unique name instead of your 0x address.`;
                clearMateIdBtn.classList.add('hidden');
            }
        }

        function showStatusMessage(message, type = 'info', hash = null) {
            const id = 'msg-' + Date.now();
            let icon, colorClasses, content;
            let transactionLink = hash ? ` <a href="https://sepolia.etherscan.io/tx/${hash}" target="_blank" class="font-bold underline text-white/90 hover:text-white">View Transaction</a>` : '';

            switch (type) {
                case 'success':
                    icon = '✅';
                    colorClasses = 'bg-green-500/20 text-green-300 border-green-500';
                    content = `<p class="font-semibold">${icon} Success!</p><p>${message}</p>${transactionLink}`;
                    break;
                case 'error':
                    icon = '❌';
                    colorClasses = 'bg-red-500/20 text-red-300 border-red-500';
                    content = `<p class="font-semibold">${icon} Error:</p><p>${message}</p>${transactionLink}`;
                    break;
                case 'alert':
                    icon = '🔔';
                    colorClasses = 'bg-yellow-500/20 text-yellow-300 border-yellow-500';
                    content = `<p class="font-semibold">${icon} Action Required:</p><p>${message}</p>`;
                    break;
                default: // info
                    icon = 'ℹ️';
                    colorClasses = 'bg-primary/20 text-primary border-primary';
                    content = `<p>${icon} ${message}</p>`;
            }

            const messageDiv = document.createElement('div');
            messageDiv.id = id;
            messageDiv.className = `p-4 mb-3 rounded-lg border shadow-lg ${colorClasses} transition-all duration-300 ease-in-out transform translate-x-0`;
            messageDiv.innerHTML = content;

            statusMessageContainer.prepend(messageDiv);
            
            setTimeout(() => {
                messageDiv.classList.add('opacity-0', 'translate-x-full');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, 7000);
        }

        function updateWalletUI(account) {
            if (account) {
                connectWalletBtn.classList.add('hidden');
                walletInfo.classList.remove('hidden');
                accountAddress.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`;
                networkId.textContent = 'Sepolia'; 
                submitBillBtn.removeAttribute('disabled');
                submitBillBtn.textContent = 'Create Bill';
                mateIdDisplay.classList.remove('hidden'); 

            } else {
                connectWalletBtn.classList.remove('hidden');
                walletInfo.classList.add('hidden');
                submitBillBtn.setAttribute('disabled', true);
                submitBillBtn.textContent = 'Connect Wallet to Create Bill';
                mateIdDisplay.classList.add('hidden'); 
            }
        }

        function updateSplitSummary() {
            const totalAmountStr = totalAmountInput.value;
            const totalAmount = parseFloat(totalAmountStr);
            const isManual = splitTypeSelect.value === 'manual';
            const participantInputs = document.querySelectorAll('#participantContainer input[name="participant-amount"]');
            const numParticipants = participantInputs.length;
            
            if (isNaN(totalAmount) || totalAmount <= 0 || numParticipants === 0) {
                splitSummary.textContent = "Summary: Enter Bill Amount and add Participants to see the split.";
                return;
            }

            let summaryText = '';
            
            if (!isManual) {
                // Equal Split Logic
                const totalShares = numParticipants + 1; // Participants + Creator
                const share = (totalAmount / totalShares);
                
                summaryText = `Equal Split: Total Bill of $${totalAmount.toFixed(2)} will be split equally among ${totalShares} people. Each share is **$${share.toFixed(2)}**.`;

            } else {
                // Manual Split Logic
                let enteredTotal = 0;
                participantInputs.forEach(input => {
                    const val = parseFloat(input.value);
                    if (!isNaN(val)) {
                        enteredTotal += val;
                    }
                });

                const remainingAmount = totalAmount - enteredTotal;
                
                if (remainingAmount >= 0) {
                    summaryText = `Manual Split: $${enteredTotal.toFixed(2)} entered for ${numParticipants} participants. **Remaining Creator Share: $${remainingAmount.toFixed(2)}**.`;
                } else {
                    const excess = Math.abs(remainingAmount);
                    summaryText = `❌ Error: Total entered ($${enteredTotal.toFixed(2)}) is **$${excess.toFixed(2)}** over the Total Bill! Please adjust shares.`;
                }
            }

            splitSummary.innerHTML = summaryText;
        }

        function toggleSplitTypeFields() {
            const isManual = splitTypeSelect.value === 'manual';
            const manualInputs = document.querySelectorAll('.split-manual-input');
            
            manualInputs.forEach(input => {
                if (isManual) {
                    input.style.display = 'block';
                    input.setAttribute('required', 'true');
                } else {
                    input.style.display = 'none';
                    input.removeAttribute('required');
                    input.value = ''; 
                }
            });
            updateSplitSummary();
        }

        function addParticipantField() {
            participantCount++;
            const isManual = splitTypeSelect.value === 'manual';
            
            const participantGroup = document.createElement('div');
            participantGroup.className = 'flex items-center space-x-2';
            participantGroup.innerHTML = `
                <input type="text" name="participant-address" placeholder="Participant ${participantCount} Address, ENS, or Saved Name (e.g., 'david.mate')" required
                    class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50 participant-address-input" />
                <input type="number" name="participant-amount" step="0.01" placeholder="Share (USD, if Manual)" 
                    class="w-full p-3 rounded-lg bg-input border border-border text-foreground focus:ring-2 focus:ring-primary/50 focus:border-primary/50 split-manual-input" 
                    style="display:${isManual ? 'block' : 'none'}; flex-grow: 0.5;" ${isManual ? 'required' : ''}/>
                <button type="button" onclick="this.parentElement.remove(); participantCount--; updateSplitSummary();" 
                    class="bg-red-500/20 text-red-500 hover:bg-red-500/30 text-sm font-semibold py-1 px-3 rounded-lg transition duration-300 ml-2">Remove</button>
            `;

            const addressInput = participantGroup.querySelector('.participant-address-input');
            
            addressInput.addEventListener('blur', async (e) => {
                const inputVal = e.target.value.trim();
                const lowerVal = inputVal.toLowerCase();
                e.target.classList.remove('border-green-500', 'border-yellow-500', 'border-primary'); 

                const resolvedAddress = await resolveNameOrAddress(inputVal); // Use the unified resolver
                
                if (resolvedAddress) {
                    let titleText = `Resolved to: ${resolvedAddress}`;
                    if (lowerVal === 'me') {
                        titleText = "Alias for Your Wallet";
                    } else if (lowerVal.endsWith(MATE_SUFFIX)) {
                        titleText = "Resolved from Local .mate ID";
                    } else if (lowerVal.endsWith('.eth')) {
                        titleText = "Resolved from ENS Name";
                    } else {
                        titleText = "Resolved from Local Address Book";
                    }
                    e.target.title = titleText;
                    e.target.classList.add('border-green-500');
                } else if (lowerVal.endsWith('.eth')) {
                    e.target.title = `ENS Name: Will attempt to resolve on submission.`;
                    e.target.classList.add('border-primary'); 
                } else if (inputVal !== "" && !ADDRESS_REGEX.test(inputVal)) {
                    e.target.title = `Warning: This does not look like a valid address, ENS, or saved name.`;
                    e.target.classList.add('border-yellow-500');
                }
            });
            
            const amountInput = participantGroup.querySelector('input[name="participant-amount"]');
            if (amountInput) {
                amountInput.addEventListener('input', updateSplitSummary);
            }

            participantContainer.appendChild(participantGroup);
            updateSplitSummary();
        }

        function createBillCard(bill) {
            const isCreator = bill.creator.toLowerCase() === currentAccount.toLowerCase();
            const isComplete = bill.status === 'COMPLETE';
            const statusColor = isComplete ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300';
            const creatorTag = isCreator ? '<span class="text-xs bg-primary/20 text-primary rounded-full px-2 py-0.5 ml-2">Creator</span>' : '';
            const actionText = isComplete ? 'Settled' : 'Pay Share';

            const card = document.createElement('div');
            card.className = 'bg-card p-6 rounded-xl border border-border shadow-lg';
            card.innerHTML = `
                <div class="flex items-center justify-between border-b border-border pb-2 mb-2">
                    <h4 class="text-xl font-bold text-white">${bill.description}</h4>
                    <div class="flex items-center">
                        <span class="text-sm font-semibold rounded-full px-3 py-1 ${statusColor}">${bill.status}</span>
                        ${creatorTag}
                    </div>
                </div>
                <p class="text-sm text-foreground/70">Bill ID: <span class="font-mono text-xs">${bill.billId}</span></p>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <p class="font-semibold text-primary">Total Bill: <span class="font-mono text-base">${bill.totalAmountEth} ETH</span></p>
                    <p class="font-semibold text-secondary">You Owe: <span class="font-mono text-base">${bill.yourShareEth} ETH</span></p>
                </div>

                <div class="pt-3 border-t border-border mt-3 flex justify-end">
                    <button class="pay-share-btn bg-primary text-background font-bold py-2 px-4 rounded-lg hover:bg-primary/80 transition duration-300 disabled:opacity-50"
                            data-bill-id="${bill.billId}"
                            data-share-wei="${bill.yourShareWei}"
                            data-is-complete="${isComplete}"
                            ${isComplete ? 'disabled' : ''}>
                        ${actionText}
                    </button>
                </div>
            `;

            const payBtn = card.querySelector('.pay-share-btn');
            if (payBtn) {
                payBtn.addEventListener('click', async (e) => {
                    if (e.target.disabled) return;
                    showStatusMessage(`Attempting to pay share for Bill ID ${e.target.dataset.billId}.`, 'info');
                    // await handlePayShare(e.target.dataset.billId, e.target.dataset.shareWei);
                });
            }

            return card;
        }

        async function loadUserBills() {
            if (!currentAccount) return;
            billsList.innerHTML = '<p class="text-center text-primary/50">Loading your bills...</p>';

            try {
                // --- MOCK DATA FOR DEMO --- (Replace with actual contract calls)
                const mockBills = [
                    { billId: '0', description: 'Office Supplies', creator: currentAccount, totalAmountEth: '0.15', yourShareEth: '0.05', yourShareWei: '50000000000000000', status: 'OPEN' },
                    { billId: '1', description: 'Weekend Getaway', creator: '0x1234567890123456789012345678901234567890', totalAmountEth: '0.50', yourShareEth: '0.25', yourShareWei: '250000000000000000', status: 'COMPLETE' },
                ];
                // --- END MOCK DATA ---

                billsList.innerHTML = '';
                if (mockBills.length === 0) {
                    billsList.innerHTML = '<p class="text-center text-secondary/70">You are not involved in any bills yet. Create one!</p>';
                    return;
                }

                mockBills.forEach(bill => {
                    billsList.appendChild(createBillCard(bill));
                });

                // Update Balances (Mocked)
                totalDueToYouEl.textContent = '0.00 ETH'; 
                totalYouOweEl.textContent = '0.05 ETH'; 
                netBalanceEl.textContent = '-0.05 ETH';

            } catch (error) {
                console.error("Error loading bills:", error);
                showStatusMessage("Failed to load bills. Check network and contract connection.", 'error');
                billsList.innerHTML = '<p class="text-center text-red-500/70">Error: Could not retrieve bill data.</p>';
            }
        }

        // --- CORE APPLICATION LOGIC ---

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0];
                    updateWalletUI(currentAccount);
                    splitMateContract = new web3.eth.Contract(CONTRACT_ABI, SPLITMATE_CONTRACT_ADDRESS);
                    
                    loadAddressBook(); // Loads contacts, 'me' alias, and updates .mate ID display
                    loadUserBills();
                } catch (error) {
                    console.error("User denied account access or error:", error);
                    showStatusMessage("Wallet connection failed. Please try again.", 'error');
                }
            } else {
                showStatusMessage("MetaMask or a Web3 provider is not installed. Please install it to use SplitMate.", 'error');
            }
        }

        async function resolveNameOrAddress(nameOrAddress) {
            const lowerVal = nameOrAddress.toLowerCase();
            
            // 1. Check for 'me' alias
            if (lowerVal === 'me' && currentAccount) {
                return currentAccount;
            }

            // 2. Check Local Address Book (handles friends' names, pre-saved ENS, and self-registered .mate IDs)
            if (addressBook[lowerVal]) {
                return addressBook[lowerVal];
            } 
            
            // 3. Check standard 0x address
            if (ADDRESS_REGEX.test(nameOrAddress)) {
                return nameOrAddress;
            }

            // 4. Check ENS name resolution (only if connected)
            if (lowerVal.endsWith('.eth') && web3) {
                try {
                    const resolvedAddress = await web3.eth.ens.getAddress(lowerVal);
                    return resolvedAddress === '0x0000000000000000000000000000000000000000' ? null : resolvedAddress;
                } catch (e) {
                    return null; 
                }
            } 
            
            return null;
        }

        async function handleBillSubmission(event) {
            event.preventDefault();
            
            if (!currentAccount) {
                showStatusMessage("Please connect your wallet first.", 'error');
                return;
            }

            const description = document.getElementById('bill-description').value;
            const totalAmountUSD = parseFloat(totalAmountInput.value);
            const merchantAddressInput = document.getElementById('merchant-address').value.trim();
            const splitType = splitTypeSelect.value;

            if (isNaN(totalAmountUSD) || totalAmountUSD <= 0) {
                showStatusMessage("Please enter a valid total amount.", 'error');
                return;
            }
            
            // --- DEBUGGING LOG ADDED HERE ---
            console.log("DEBUG: Checking Merchant Address Resolution:");
            console.log(`Input Name: ${merchantAddressInput.toLowerCase()}`);
            console.log("Current Address Book (for lookup):", addressBook);
            // ---------------------------------

            // --- STEP 1: RESOLVE MERCHANT ADDRESS ---
            let merchantAddress = await resolveNameOrAddress(merchantAddressInput);
            
            if (!merchantAddress) {
                let errorMessage = `Invalid Merchant Address/Name: **${merchantAddressInput}** could not be resolved.`;
                
                // --- IMPROVED ERROR MESSAGE FOR .MATE ID ---
                if (merchantAddressInput.toLowerCase().endsWith(MATE_SUFFIX)) {
                     errorMessage += ` Please ensure you have: 1) Connected your wallet, and 2) Registered **${merchantAddressInput}** on the **Profile / ID** page. (Check console for debug data.)`;
                }
                
                showStatusMessage(errorMessage, 'error');
                return;
            }
            
            // --- STEP 2: GATHER & RESOLVE PARTICIPANTS ---
            const participantAddressInputs = document.querySelectorAll('input[name="participant-address"]');
            const participantAmountInputs = document.querySelectorAll('input[name="participant-amount"]');
            
            let participants = []; 
            let amountsWei = []; 
            let totalParticipantsAmountUSD = 0; 
            const exchangeRate = 100000; 
            
            for (let i = 0; i < participantAddressInputs.length; i++) {
                const nameOrAddress = participantAddressInputs[i].value.trim();
                let resolvedAddress = await resolveNameOrAddress(nameOrAddress);

                if (!resolvedAddress) {
                    let participantError = `Invalid Participant Input: Failed to resolve name/address for **${nameOrAddress}**`;
                    if (nameOrAddress.toLowerCase().endsWith(MATE_SUFFIX)) {
                         participantError += ` (Check Profile / ID page for registration).`;
                    }
                    showStatusMessage(participantError, 'error');
                    return;
                }

                // Prevent adding the creator twice (once as a participant and once in Step 3)
                if (resolvedAddress.toLowerCase() === currentAccount.toLowerCase()) {
                     showStatusMessage(`Do not manually add your own address/ID as a participant. The creator is added automatically in the final step.`, 'error');
                     return;
                }

                let amountUSD;
                if (splitType === 'equal') {
                    amountUSD = totalAmountUSD / (participantAddressInputs.length + 1);
                } else { 
                    amountUSD = parseFloat(participantAmountInputs[i].value);
                    if (isNaN(amountUSD) || amountUSD <= 0) {
                        showStatusMessage(`Invalid manual share amount for participant ${i + 1}.`, 'error');
                        return;
                    }
                    totalParticipantsAmountUSD += amountUSD;
                }

                participants.push(resolvedAddress);
                
                const amountWei = web3.utils.toBN(Math.round(amountUSD * exchangeRate));
                amountsWei.push(amountWei.toString());
            }

            // --- STEP 3: ADD CREATOR'S SHARE AND FINAL VALIDATION ---
            let creatorShareUSD = 0;
            if (splitType === 'equal') {
                creatorShareUSD = totalAmountUSD / (participantAddressInputs.length + 1);
            } else { 
                creatorShareUSD = totalAmountUSD - totalParticipantsAmountUSD;
            }

            if (creatorShareUSD < 0) {
                showStatusMessage(`Manual split error: Total participant shares ($${totalParticipantsAmountUSD.toFixed(2)}) exceed the total bill amount ($${totalAmountUSD.toFixed(2)}).`, 'error');
                return;
            }
            
            participants.push(currentAccount);
            const creatorShareWei = web3.utils.toBN(Math.round(creatorShareUSD * exchangeRate));
            amountsWei.push(creatorShareWei.toString());

            const transactionValue = '0'; 

            try {
                showStatusMessage("Sending transaction to create bill...", 'info');
                
                // MOCK SUCCESS RECEIPT for UI Demo
                const txHash = '0xMockTxHash1234567890abcdef1234567890abcdef1234567890abcdef';
                
                showStatusMessage(`Bill **${description}** successfully created!`, 'success', txHash);
                showStatusMessage(`**NEXT STEP:** Pay your own share (estimated ${creatorShareUSD.toFixed(2)} USD). You are automatically included as a participant but must send the transaction.`, 'alert');
                
                billForm.reset();
                participantContainer.innerHTML = '';
                participantCount = 0;
                updateSplitSummary();
                loadUserBills();
                
            } catch (error) {
                console.error("Bill creation failed:", error);
                const errorMessage = error.message.includes('revert') ? "Transaction failed (EVM Revert). Check your inputs and shares." : error.message;
                showStatusMessage(`Bill creation failed: ${errorMessage}`, 'error');
            }
        }

        // --- HANDLERS ---

        connectWalletBtn.addEventListener('click', connectWallet);
        addParticipantBtn.addEventListener('click', addParticipantField);
        splitTypeSelect.addEventListener('change', toggleSplitTypeFields);
        totalAmountInput.addEventListener('input', updateSplitSummary);
        saveContactBtn.addEventListener('click', saveContactToAddressBook);
        clearMateIdBtn.addEventListener('click', clearMateId); // NEW HANDLER

        // Handler for the .mate ID display in the header (navigates to the new Profile page)
        mateIdDisplay.addEventListener('click', () => {
            if (currentAccount) {
                 navigate('#profile'); 
            } else {
                 showStatusMessage("Please connect your wallet to manage your ID.", 'error');
            }
        });


        participantContainer.addEventListener('input', (e) => {
            if (e.target.name === 'participant-amount') {
                updateSplitSummary();
            }
        });
        billForm.addEventListener('submit', handleBillSubmission);


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            updateWalletUI(null);

            // Navigation setup
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const hash = e.target.getAttribute('href');
                    navigate(hash);
                    if (hash === '#dashboard' && currentAccount) {
                        loadUserBills(); 
                    }
                });
            });

            const initialHash = window.location.hash || '#dashboard';
            navigate(initialHash);
            
            // Passive Auto-Connect Check
            if (window.ethereum) {
                web3 = new Web3(window.ethereum); 
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        updateWalletUI(currentAccount);
                        splitMateContract = new web3.eth.Contract(CONTRACT_ABI, SPLITMATE_CONTRACT_ADDRESS); 
                        
                        loadAddressBook();
                        loadUserBills(); 
                    }
                } catch (error) {
                    console.warn("Could not auto-connect, user interaction required.");
                    loadAddressBook(); 
                }
            } else {
                loadAddressBook(); 
            }
            
            updateSplitSummary(); 
            toggleSplitTypeFields();
        });

        function navigate(hash) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelector(hash).classList.remove('hidden');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === hash) {
                    link.classList.remove('text-foreground');
                    link.classList.add('text-primary');
                } else {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground');
                }
            });
        }
    </script>
</body>
</html>