<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Decentralized Bill Splitting</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Apply Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #10002b;
        }
        ::-webkit-scrollbar-thumb {
            background: #7400b8; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #c77dff; 
        }
    </style>
    
    <script>
        // --- Tailwind Configuration (UI Theme) ---
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                background: "#10002b",
                card: { DEFAULT: "rgba(255, 255, 255, 0.05)", foreground: "hsl(210 40% 98%)" },
                primary: {
                  DEFAULT: "#c77dff", // Bright Electric Purple
                  active: "#7400b8", 
                  foreground: "hsl(210 40% 98%)",
                },
                secondary: {
                  DEFAULT: "#ff9e00", // Vibrant Orange
                  foreground: "hsl(210 40% 98%)",
                },
                border: "hsl(260 20% 25%)", 
                input: "hsl(260 20% 25%)",
                ring: "hsl(260 20% 25%)",
                foreground: "hsl(210 40% 98%)",
                muted: {
                  DEFAULT: "hsl(215 20% 60%)",
                  foreground: "hsl(215 20% 80%)",
                },
              },
              borderRadius: {
                xl: "1.25rem",
                lg: "1rem",
              }
            }
          }
        }

        // ====================================================================
        // --- GLOBAL UI & MESSAGE BOX ---
        // ====================================================================

        window.showMessageBox = function(title, content, onOk = null) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            const okButton = document.querySelector('#message-box button');
            
            okButton.onclick = null; 
            okButton.onclick = () => {
                closeMessageBox();
                if (typeof onOk === 'function') {
                    onOk();
                }
            };

            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        window.closeMessageBox = function() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }


        // ====================================================================
        // --- WALLET UI UPDATE (Called by wallet.js) ---
        // ====================================================================

        /**
         * Updates the Connect Wallet button based on the global state.
         * Assumes window.userAddress is managed by wallet.js.
         */
        window.updateWalletUI = function() {
            const btn = document.getElementById('connect-wallet-btn');
            const mobileBtn = document.getElementById('mobile-connect-btn');
            
            if (window.userAddress && typeof window.userAddress === 'string') {
                const shortAddress = window.userAddress.substring(0, 6) + '...' + window.userAddress.slice(-4);
                
                // Desktop Button Update
                btn.textContent = shortAddress;
                btn.classList.remove('bg-primary', 'hover:bg-primary/90');
                btn.classList.add('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono'); 
                
                // Mobile Button Update
                mobileBtn.textContent = shortAddress;
                mobileBtn.classList.remove('text-primary', 'bg-primary/20');
                mobileBtn.classList.add('bg-green-600/20', 'text-green-400');
            } else {
                // Desktop Button Reset
                btn.textContent = "Connect Wallet";
                btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono');
                btn.classList.add('bg-primary', 'hover:bg-primary/90');

                // Mobile Button Reset
                mobileBtn.textContent = "Connect Wallet";
                mobileBtn.classList.remove('bg-green-600/20', 'text-green-400');
                mobileBtn.classList.add('text-primary', 'bg-primary/20');
            }
            // Reload content to update bill lists based on connection status
            loadDashboardContent();
            loadLeaderboard(); 
        }

        // ====================================================================
        // --- SPA ROUTING AND NAVIGATION ---
        // ====================================================================
        
        const VIEWS = ['dashboard', 'create', 'leaderboard'];
        
        window.navigateTo = function(viewId) {
            if (!VIEWS.includes(viewId)) return;

            // 1. Hide all views and show target view
            VIEWS.forEach(id => { document.getElementById(id + '-view')?.classList.add('hidden'); });
            document.getElementById(viewId + '-view')?.classList.remove('hidden');

            const titleMap = { 'dashboard': 'Dashboard', 'create': 'Create Bill', 'leaderboard': 'Reputation Leaderboard' };
            document.getElementById('main-header-title').textContent = titleMap[viewId] || 'SplitMate';

            // 2. Load necessary data
            if (viewId === 'dashboard') loadDashboardContent(); 
            else if (viewId === 'leaderboard') loadLeaderboard();

            // 3. Hide mobile menu
            document.getElementById('mobile-menu').classList.add('hidden');
            
            // Ensure the wallet button UI is refreshed on the new page
            window.updateWalletUI(); 
        }

        // ====================================================================
        // --- DASHBOARD LOGIC (Calls wallet.js/contract) ---
        // ====================================================================

        function renderBillCard(bill) {
            const userAddress = window.userAddress || "0xUnconnectedUser";
            const isPayer = bill.payer === userAddress;
            const statusColor = bill.status === 'Open' ? 'text-primary' : 'text-green-400';
            const actionButton = bill.status === 'Open' ? 
                `<button class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-semibold hover:bg-opacity-80 transition">
                    ${isPayer ? 'Manage' : 'Pay Now'}
                </button>` :
                `<span class="text-green-400 text-sm font-semibold">Settled</span>`;
            
            const shareDisplay = isPayer ? bill.totalAmount : bill.yourShare;

            return `
                <div class="p-4 bg-card rounded-xl border border-border shadow-lg transition duration-300 hover:border-primary/50 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
                    <div class="flex flex-col">
                        <h3 class="text-xl font-bold text-foreground">${bill.name}</h3>
                        <p class="text-sm text-muted">
                            ${isPayer ? 'You Paid' : 'Owed to'} <span class="font-mono text-xs text-primary/80">${bill.payer.substring(0, 6)}...${bill.payer.slice(-4)}</span>
                        </p>
                    </div>
                    
                    <div class="flex items-center space-x-6">
                        <div class="flex flex-col text-right">
                            <span class="text-2xl font-extrabold ${statusColor}">$${parseFloat(shareDisplay).toFixed(2)}</span>
                            <span class="text-xs text-muted">${isPayer ? 'Total Bill' : 'Your Share'}</span>
                        </div>
                        ${actionButton}
                    </div>
                </div>
            `;
        }

        window.loadDashboardContent = async function() {
            const listContainer = document.getElementById('bill-list');
            const userAddress = window.userAddress; 
            
            if (!userAddress) {
                listContainer.innerHTML = '<p class="text-center text-secondary p-8 font-semibold">Please connect your wallet to view your bills.</p>';
                document.getElementById('total-owed').textContent = `$0.00`;
                document.getElementById('total-due').textContent = `$0.00`;
                document.getElementById('net-balance').textContent = `$0.00`;
                return;
            }

            listContainer.innerHTML = '<div class="text-center p-8 text-primary font-semibold">Fetching live bills from the contract...</div>';

            try {
                const bills = await window.fetchUserBills(userAddress); 
                
                let totalOwed = 0;
                let totalDue = 0;

                listContainer.innerHTML = '';

                if (bills.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-muted p-8">No bills found. Start a new split!</p>';
                } else {
                    bills.forEach(bill => {
                        const userShareObj = bill.shares.find(s => s.address === userAddress);
                        const userShare = userShareObj ? userShareObj.amount : 0;
                        
                        const billForRender = {
                            ...bill,
                            yourShare: userShare,
                            status: bill.isSettled ? 'Settled' : 'Open'
                        };
                        listContainer.insertAdjacentHTML('beforeend', renderBillCard(billForRender));
                        
                        if (billForRender.status === 'Open') {
                            if (bill.payer === userAddress) {
                                totalOwed += (bill.totalAmount - userShare); 
                            } else {
                                totalDue += userShare; 
                            }
                        }
                    });
                }

                document.getElementById('total-owed').textContent = `$${totalOwed.toFixed(2)}`;
                document.getElementById('total-due').textContent = `$${totalDue.toFixed(2)}`;
                
                const netBalance = totalOwed - totalDue;
                document.getElementById('net-balance').textContent = `$${netBalance.toFixed(2)}`;
                
                document.getElementById('net-balance').classList.remove('text-green-400', 'text-red-400', 'text-foreground');
                document.getElementById('net-balance').classList.add(
                    netBalance > 0 ? 'text-green-400' : netBalance < 0 ? 'text-red-400' : 'text-foreground'
                );
            } catch (error) {
                console.error("Failed to load dashboard data:", error);
                listContainer.innerHTML = `<div class="text-center p-8 text-red-400">Error loading data. Is the contract connected?</div>`;
            }
        }

        // ====================================================================
        // --- CREATE BILL LOGIC ---
        // ====================================================================

        function toggleSplit(type) {
            const manualContainer = document.getElementById('manual-split-container');
            
            document.getElementById('split-type-even').classList.remove('bg-primary/50');
            document.getElementById('split-type-manual').classList.remove('bg-primary/50');
            
            if (type === 'even') {
                document.getElementById('split-type-even').classList.add('bg-primary/50');
                manualContainer.classList.add('hidden');
                document.querySelectorAll('.manual-share-input').forEach(el => el.required = false);
            } else if (type === 'manual') {
                document.getElementById('split-type-manual').classList.add('bg-primary/50');
                manualContainer.classList.remove('hidden');
                document.querySelectorAll('.manual-share-input').forEach(el => el.required = true);
            }
            document.getElementById('split-type-input').value = type;
            // Refresh participant inputs to show/hide share fields
            updateParticipants(parseInt(document.getElementById('participant-count').value));
        }

        function updateParticipants(count) {
            const participantCount = Math.max(0, count);
            document.getElementById('participant-count').value = participantCount;
            
            // CRITICAL FIX: The element the script expects to update
            document.getElementById('participant-count-display').textContent = participantCount;

            const participantsContainer = document.getElementById('participants-list');
            participantsContainer.innerHTML = '';

            const isManual = document.getElementById('split-type-input').value === 'manual';

            for (let i = 0; i < participantCount; i++) {
                const index = i + 1;
                const shareInputHtml = isManual ? `
                    <input type="number" placeholder="Share ($)" 
                           class="manual-share-input bg-input/50 border border-border text-foreground rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-1/3" 
                           name="participant-${index}-share" step="0.01" min="0" required>
                ` : '';

                const participantInput = `
                    <div class="flex items-center space-x-2 mb-3">
                        <input type="text" placeholder="Participant ${index} Address (0x...)" 
                               class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full" 
                               name="participant-${index}-address" required>
                        ${shareInputHtml}
                    </div>
                `;
                participantsContainer.insertAdjacentHTML('beforeend', participantInput);
            }
        }

        function changeParticipantCount(delta) {
            let currentCount = parseInt(document.getElementById('participant-count').value) || 0;
            currentCount += delta;
            updateParticipants(currentCount);
        }

        function validateForm(formData) {
            if (!window.userAddress) {
                showMessageBox("Connection Required", "Please connect your wallet before creating a bill.");
                return false;
            }
            // ... (rest of validation logic remains the same) ...
            return true;
        }


        window.submitBill = async function() {
            // ... (bill submission logic remains the same) ...
            // Calls window.sendBillToContract (must contain live code)
        }

        // ====================================================================
        // --- LEADERBOARD LOGIC (Calls wallet.js/contract) ---
        // ====================================================================
        
        window.loadLeaderboard = async function() {
            const container = document.getElementById('leaderboard-list');
            if (!container || !window.fetchLeaderboard) return;

            container.innerHTML = '<div class="text-center p-8 text-primary font-semibold">Fetching live reputation scores...</div>';

            try {
                // Calls window.fetchLeaderboard (must contain live code/mock data)
                const leaderboardData = await window.fetchLeaderboard();
                renderLeaderboardList(leaderboardData);

            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                container.innerHTML = `<div class="text-center p-8 text-red-400">Error loading data. Is the contract connected?</div>`;
            }
        }

        function renderLeaderboardList(data) {
            // ... (rendering logic remains the same) ...
        }


        // ====================================================================
        // --- INITIALIZATION ---
        // ====================================================================

        function setupInitialUI() {
            toggleSplit('even'); 
            updateParticipants(0); // Start with 0 participants
            
            document.getElementById('bill-form').addEventListener('submit', function(e) { 
                e.preventDefault(); 
                submitBill(); 
            });

            document.getElementById('menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            navigateTo('dashboard');
        }

        document.addEventListener('DOMContentLoaded', setupInitialUI);
    </script>
    
</head>
<body class="bg-background min-h-screen text-foreground antialiased overflow-x-hidden">

    <div id="message-box" class="hidden fixed inset-0 z-50 bg-background/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-[#1a0035] border border-primary/50 rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="message-title" class="text-xl font-bold mb-2 text-primary">Notification</h3>
            <p id="message-content" class="text-muted mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeMessageBox()" class="px-6 py-2 bg-primary/70 rounded-lg text-white font-semibold hover:bg-primary transition duration-200 shadow-lg">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <nav class="sticky top-0 z-40 bg-background/90 backdrop-blur-md border-b border-border shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-3xl font-extrabold text-primary tracking-wider">Split<span class="text-secondary">Mate</span></span>
                </div>
                
                <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                    <a href="#" onclick="navigateTo('dashboard')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Dashboard</a>
                    <a href="#" onclick="navigateTo('create')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Create Bill</a>
                    <a href="#" onclick="navigateTo('leaderboard')" class="text-muted hover:text-primary px-3 py-2 rounded-lg text-sm font-medium transition duration-200">Leaderboard</a>
                </div>
                
                <div class="hidden sm:block">
                    <button id="connect-wallet-btn" onclick="window.connectWallet()" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-md shadow-primary/30">
    Connect Wallet
</button>
                </div>

                <div class="sm:hidden flex items-center">
                    <button id="menu-toggle" type="button" class="inline-flex items-center justify-center p-2 rounded-lg text-primary hover:text-white hover:bg-primary/20 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary/50" aria-controls="mobile-menu" aria-expanded="false">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#" onclick="navigateTo('dashboard')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Dashboard</a>
                <a href="#" onclick="navigateTo('create')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Create Bill</a>
                <a href="#" onclick="navigateTo('leaderboard')" class="block px-3 py-2 rounded-lg text-base font-medium text-foreground hover:bg-primary/20 transition">Leaderboard</a>
                <button id="mobile-connect-btn" onclick="window.connectWallet()" class="w-full text-left px-3 py-2 bg-primary/20 rounded-lg text-base font-medium text-primary hover:bg-primary/40 transition">
    Connect Wallet
</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <h1 id="main-header-title" class="text-3xl sm:text-4xl font-extrabold text-foreground mb-8 border-b-2 border-primary/20 pb-2">Dashboard</h1>

        <section id="dashboard-view" class="space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Total Owed To You</h2>
                    <p id="total-owed" class="text-4xl font-extrabold text-green-400">$0.00</p>
                </div>
                
                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Total You Owe</h2>
                    <p id="total-due" class="text-4xl font-extrabold text-red-400">$0.00</p>
                </div>

                <div class="bg-card rounded-xl p-6 border border-border shadow-2xl">
                    <h2 class="text-muted text-lg font-medium mb-1">Net Balance</h2>
                    <p id="net-balance" class="text-4xl font-extrabold text-foreground">$0.00</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-primary mb-4">Your Recent Bills</h2>
                <div id="bill-list" class="space-y-4">
                    <div class="text-center p-8 text-muted">Please connect your wallet...</div>
                </div>
            </div>

            <div class="pt-4 text-center">
                <button onclick="navigateTo('create')" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-xl transition duration-300 text-lg shadow-lg shadow-primary/30">
                    Split a New Bill
                </button>
            </div>

        </section>

        <section id="create-view" class="hidden">
            <div class="max-w-2xl mx-auto bg-card p-6 sm:p-8 rounded-xl border border-border shadow-2xl">
                <form id="bill-form" class="space-y-6">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="bill-name" class="block text-sm font-medium text-muted mb-2">Bill Name (e.g., Dinner, Rent)</label>
                            <input type="text" id="bill-name" name="bill-name" required placeholder="Enter bill name"
                                   class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full"
                            >
                        </div>
                        <div>
                            <label for="bill-amount" class="block text-sm font-medium text-muted mb-2">Total Amount (USDC/ETH)</label>
                            <input type="number" id="bill-amount" name="bill-amount" required step="0.01" min="0.01" placeholder="100.00"
                                   class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full"
                            >
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-muted mb-3">Split Type</label>
                        <input type="hidden" id="split-type-input" value="even">
                        <div class="flex space-x-4">
                            <button type="button" id="split-type-even" onclick="toggleSplit('even')"
                                    class="flex-1 px-4 py-3 rounded-xl border border-primary/50 text-foreground font-semibold transition duration-200 bg-primary/50 hover:bg-primary/20">
                                Evenly
                            </button>
                            <button type="button" id="split-type-manual" onclick="toggleSplit('manual')"
                                    class="flex-1 px-4 py-3 rounded-xl border border-primary/50 text-foreground font-semibold transition duration-200 hover:bg-primary/20">
                                Manual Shares
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-muted mb-3">Number of Participants (excluding Payer)</label>
                        
                        <div class="flex items-center space-x-4 bg-input/50 p-3 rounded-xl border border-border">
                            <button type="button" onclick="changeParticipantCount(-1)" 
                                    class="w-10 h-10 bg-primary/20 text-primary rounded-lg text-2xl font-bold hover:bg-primary/40 transition duration-200">
                                &minus;
                            </button>
                            
                            <span id="participant-count-display" 
                                class="w-16 text-center text-foreground bg-transparent text-xl font-bold border-none focus:outline-none">0</span>
                                
                            <input type="hidden" id="participant-count" name="participant-count" value="0"> 
                            
                            <button type="button" onclick="changeParticipantCount(1)" 
                                    class="w-10 h-10 bg-primary/20 text-primary rounded-lg text-2xl font-bold hover:bg-primary/40 transition duration-200">
                                &plus;
                            </button>
                        </div>
                    </div>

                    <div id="manual-split-container" class="space-y-4 hidden pt-4 border-t border-border mt-6">
                        <h3 class="text-xl font-bold text-primary">Participant Details</h3>
                        <div id="participants-list">
                            </div>
                        <p class="text-xs text-muted">For Manual Split, ensure the sum of all shares (including the Payer's calculated share) equals the 'Total Amount'.</p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-bold py-3 rounded-xl transition duration-300 text-lg shadow-lg shadow-secondary/30">
                        Broadcast Bill to SplitMate
                    </button>
                </form>
            </div>
        </section>

        <section id="leaderboard-view" class="hidden">
            <div class="max-w-3xl mx-auto">
                <div class="bg-card p-6 rounded-xl border border-border shadow-2xl mb-6">
                    <p class="text-muted text-center">
                        The SplitMate Leaderboard ranks users based on their on-chain bill settlement history. Higher reputation scores indicate a greater commitment to prompt payments.
                    </p>
                </div>
                
                <div class="mb-4 flex justify-between items-center text-sm font-semibold text-muted border-b border-border pb-2">
                    <span class="w-1/2">Rank / Address</span>
                    <span class="text-right">Reputation Score / Settled Rate</span>
                </div>

                <div id="leaderboard-list" class="space-y-3">
                    <div class="text-center p-8 text-muted">Loading leaderboard...</div>
                </div>
            </div>
        </section>
        
    </main>
    
<script src="https://cdn.jsdelivr.net/npm/starknet@latest/dist/starknet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@starknet-io/get-starknet@latest/dist/index.js"></script>
    
    <script src="wallet.js"></script> 
    
</body>
</html>