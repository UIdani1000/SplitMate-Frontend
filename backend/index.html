<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Decentralized Bill Splitting</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Apply Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #10002b;
        }
        ::-webkit-scrollbar-thumb {
            background: #7400b8; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #c77dff; 
        }
    </style>
    
    <script>
        // --- Tailwind Configuration (UI Theme) ---
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                background: "#10002b",
                card: { DEFAULT: "rgba(255, 255, 255, 0.05)", foreground: "hsl(210 40% 98%)" },
                primary: {
                  DEFAULT: "#c77dff", // Bright Electric Purple
                  active: "#7400b8", 
                  foreground: "hsl(210 40% 98%)",
                },
                secondary: {
                  DEFAULT: "#ff9e00", // Vibrant Orange
                  foreground: "hsl(210 40% 98%)",
                },
                border: "hsl(260 20% 25%)", 
                input: "hsl(260 20% 25%)",
                ring: "hsl(260 20% 25%)",
                foreground: "hsl(210 40% 98%)",
                muted: {
                  DEFAULT: "hsl(215 20% 60%)",
                  foreground: "hsl(215 20% 80%)",
                },
              },
              borderRadius: {
                xl: "1.25rem",
                lg: "1rem",
              }
            }
          }
        }

        // ====================================================================
        // --- GLOBAL UI & MESSAGE BOX (Fixes: showMessageBox is not a function) ---
        // ====================================================================

        window.showMessageBox = function(title, content, onOk = null) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').textContent = content;
            const okButton = document.querySelector('#message-box button');
            
            okButton.onclick = null; 
            okButton.onclick = () => {
                closeMessageBox();
                if (typeof onOk === 'function') {
                    onOk();
                }
            };

            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        window.closeMessageBox = function() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }


        // ====================================================================
        // --- WALLET UI UPDATE (Called by wallet.js) ---
        // ====================================================================

        /**
         * Updates the Connect Wallet button based on the global state.
         * Assumes window.userAddress is managed by wallet.js.
         */
        window.updateWalletUI = function() {
            const btn = document.getElementById('connect-wallet-btn');
            const mobileBtn = document.getElementById('mobile-connect-btn');
            
            if (window.userAddress && typeof window.userAddress === 'string') {
                const shortAddress = window.userAddress.substring(0, 6) + '...' + window.userAddress.slice(-4);
                
                btn.textContent = shortAddress;
                btn.classList.remove('bg-primary', 'hover:bg-primary/90');
                btn.classList.add('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono'); 
                
                mobileBtn.textContent = shortAddress;
                mobileBtn.classList.remove('text-primary', 'bg-primary/20');
                mobileBtn.classList.add('bg-green-600/20', 'text-green-400');
            } else {
                btn.textContent = "Connect Wallet";
                btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'text-white', 'font-mono');
                btn.classList.add('bg-primary', 'hover:bg-primary/90');

                mobileBtn.textContent = "Connect Wallet";
                mobileBtn.classList.remove('bg-green-600/20', 'text-green-400');
                mobileBtn.classList.add('text-primary', 'bg-primary/20');
            }
            // Reload content to update bill lists based on connection status
            loadDashboardContent();
            loadLeaderboard(); 
        }

        // ====================================================================
        // --- SPA ROUTING AND NAVIGATION ---
        // ====================================================================
        
        const VIEWS = ['dashboard', 'create', 'leaderboard'];
        
        // --- SPA ROUTING AND NAVIGATION ---
	window.navigateTo = function(viewId) {
    const VIEWS = ['dashboard', 'create', 'leaderboard'];
    if (!VIEWS.includes(viewId)) return;

    // 1. Hide all views and show target view
    VIEWS.forEach(id => { document.getElementById(id + '-view')?.classList.add('hidden'); });
    document.getElementById(viewId + '-view')?.classList.remove('hidden');

    const titleMap = { 'dashboard': 'Dashboard', 'create': 'Create Bill', 'leaderboard': 'Reputation Leaderboard' };
    document.getElementById('main-header-title').textContent = titleMap[viewId] || 'SplitMate';

    // 2. Load necessary data
    if (viewId === 'dashboard') loadDashboardContent(); 
    else if (viewId === 'leaderboard') loadLeaderboard();

    // 3. Hide mobile menu
    document.getElementById('mobile-menu').classList.add('hidden');
    
    // ðŸ›‘ CRITICAL FIX: Ensure the wallet button UI is refreshed on the new page
    window.updateWalletUI(); 
}

        // ====================================================================
        // --- DASHBOARD LOGIC (Calls wallet.js/contract) ---
        // ====================================================================

        /**
         * Renders a bill card. (UI only)
         */
        function renderBillCard(bill) {
            const userAddress = window.userAddress || "0xUnconnectedUser";
            const isPayer = bill.payer === userAddress;
            const statusColor = bill.status === 'Open' ? 'text-primary' : 'text-green-400';
            const actionButton = bill.status === 'Open' ? 
                `<button class="bg-secondary text-white px-3 py-1 rounded-full text-sm font-semibold hover:bg-opacity-80 transition">
                    ${isPayer ? 'Manage' : 'Pay Now'}
                </button>` :
                `<span class="text-green-400 text-sm font-semibold">Settled</span>`;
            
            // Assume your live contract data provides amount and yourShare as numbers/strings
            const shareDisplay = isPayer ? bill.totalAmount : bill.yourShare; // Corrected to use totalAmount

            return `
                <div class="p-4 bg-card rounded-xl border border-border shadow-lg transition duration-300 hover:border-primary/50 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
                    <div class="flex flex-col">
                        <h3 class="text-xl font-bold text-foreground">${bill.name}</h3>
                        <p class="text-sm text-muted">
                            ${isPayer ? 'You Paid' : 'Owed to'} <span class="font-mono text-xs text-primary/80">${bill.payer.substring(0, 6)}...${bill.payer.slice(-4)}</span>
                        </p>
                    </div>
                    
                    <div class="flex items-center space-x-6">
                        <div class="flex flex-col text-right">
                            <span class="text-2xl font-extrabold ${statusColor}">$${parseFloat(shareDisplay).toFixed(2)}</span>
                            <span class="text-xs text-muted">${isPayer ? 'Total Bill' : 'Your Share'}</span>
                        </div>
                        ${actionButton}
                    </div>
                </div>
            `;
        }

        /**
         * Loads bills from the smart contract and updates the UI.
         */
        window.loadDashboardContent = async function() {
            const listContainer = document.getElementById('bill-list');
            const userAddress = window.userAddress; // Use the corrected global variable
            
            if (!userAddress) {
                listContainer.innerHTML = '<p class="text-center text-secondary p-8 font-semibold">Please connect your wallet to view your bills.</p>';
                document.getElementById('total-owed').textContent = `$0.00`;
                document.getElementById('total-due').textContent = `$0.00`;
                document.getElementById('net-balance').textContent = `$0.00`;
                return;
            }

            listContainer.innerHTML = '<div class="text-center p-8 text-primary font-semibold">Fetching live bills from the contract...</div>';

            try {
                // LIVE CALL: Assumes fetchUserBills exists in wallet.js
                const bills = await window.fetchUserBills(userAddress); 
                
                let totalOwed = 0;
                let totalDue = 0;

                listContainer.innerHTML = '';

                if (bills.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-muted p-8">No bills found. Start a new split!</p>';
                } else {
                    bills.forEach(bill => {
                        // NOTE: You need to calculate the user's specific share from the bill.shares array
                        const userShareObj = bill.shares.find(s => s.address === userAddress);
                        const userShare = userShareObj ? userShareObj.amount : 0;
                        
                        // Add the specific share to the bill object for rendering
                        const billForRender = {
                            ...bill,
                            yourShare: userShare,
                            status: bill.isSettled ? 'Settled' : 'Open' // Derive status from contract data
                        };
                        listContainer.insertAdjacentHTML('beforeend', renderBillCard(billForRender));
                        
                        if (billForRender.status === 'Open') {
                            if (bill.payer === userAddress) {
                                // Amount owed TO the payer
                                totalOwed += (bill.totalAmount - userShare); 
                            } else {
                                // Amount owed BY the participant
                                totalDue += userShare; 
                            }
                        }
                    });
                }

                document.getElementById('total-owed').textContent = `$${totalOwed.toFixed(2)}`;
                document.getElementById('total-due').textContent = `$${totalDue.toFixed(2)}`;
                
                const netBalance = totalOwed - totalDue;
                document.getElementById('net-balance').textContent = `$${netBalance.toFixed(2)}`;
                
                document.getElementById('net-balance').classList.remove('text-green-400', 'text-red-400', 'text-foreground');
                document.getElementById('net-balance').classList.add(
                    netBalance > 0 ? 'text-green-400' : netBalance < 0 ? 'text-red-400' : 'text-foreground'
                );
            } catch (error) {
                console.error("Failed to load dashboard data:", error);
                listContainer.innerHTML = `<div class="text-center p-8 text-red-400">Error loading data. Is the contract connected?</div>`;
            }
        }

        // ====================================================================
        // --- CREATE BILL LOGIC ---
        // ====================================================================

        function toggleSplit(type) {
            const manualContainer = document.getElementById('manual-split-container');
            
            document.getElementById('split-type-even').classList.remove('bg-primary/50');
            document.getElementById('split-type-manual').classList.remove('bg-primary/50');
            
            if (type === 'even') {
                document.getElementById('split-type-even').classList.add('bg-primary/50');
                manualContainer.classList.add('hidden');
                // Hide manual share inputs
                document.querySelectorAll('.manual-share-input').forEach(el => el.required = false);
            } else if (type === 'manual') {
                document.getElementById('split-type-manual').classList.add('bg-primary/50');
                manualContainer.classList.remove('hidden');
                // Show and require manual share inputs
                document.querySelectorAll('.manual-share-input').forEach(el => el.required = true);
            }
            document.getElementById('split-type-input').value = type;
            // Update participants to show/hide share inputs
            updateParticipants(parseInt(document.getElementById('participant-count').value));
        }

        function updateParticipants(count) {
            const participantCount = Math.max(0, count); // Allow 0 participants
            document.getElementById('participant-count').value = participantCount;
            // FIX: Ensure the display element is updated (based on your original logic)
            const displayElement = document.getElementById('participant-count-display');
            if (displayElement) {
                displayElement.textContent = participantCount;
            } else {
                // If using the number input itself as the display:
                document.getElementById('participant-count').value = participantCount;
            }


            const participantsContainer = document.getElementById('participants-list');
            participantsContainer.innerHTML = '';

            const isManual = document.getElementById('split-type-input').value === 'manual';

            for (let i = 0; i < participantCount; i++) {
                const index = i + 1;
                const shareInputHtml = isManual ? `
                    <input type="number" placeholder="Share ($)" 
                           class="manual-share-input bg-input/50 border border-border text-foreground rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-1/3" 
                           name="participant-${index}-share" step="0.01" min="0" required>
                ` : '';

                const participantInput = `
                    <div class="flex items-center space-x-2 mb-3">
                        <input type="text" placeholder="Participant ${index} Address (0x...)" 
                               class="bg-input/50 border border-border text-foreground rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary transition duration-300 w-full" 
                               name="participant-${index}-address" required>
                        ${shareInputHtml}
                    </div>
                `;
                participantsContainer.insertAdjacentHTML('beforeend', participantInput);
            }
        }

        function changeParticipantCount(delta) {
            let currentCount = parseInt(document.getElementById('participant-count').value) || 0;
            currentCount += delta;
            updateParticipants(currentCount);
        }

        function validateForm(formData) {
            if (!window.userAddress) {
                showMessageBox("Connection Required", "Please connect your wallet before creating a bill.");
                return false;
            }
            if (!window.sendBillToContract) {
                showMessageBox("Contract Not Ready", "The smart contract function failed. Cannot broadcast bill.");
                return false;
            }
            if (!formData.name || !formData.amount) {
                showMessageBox("Validation Error", "Please fill in Bill Name and Total Amount.");
                return false;
            }
            
            if (formData.splitType === 'manual') {
                let totalShare = formData.shares.reduce((sum, s) => sum + parseFloat(s.amount || 0), 0);
                const billAmount = parseFloat(formData.amount);
                
                // Allow a tiny margin for float math errors
                if (Math.abs(totalShare - billAmount) > 0.02) {
                    showMessageBox("Validation Error", `Manual shares ($${totalShare.toFixed(2)}) do not match the total bill amount ($${billAmount.toFixed(2)}).`);
                    return false;
                }
            }
            return true;
        }


        window.submitBill = async function() {
            const form = document.getElementById('bill-form');
            const splitType = document.getElementById('split-type-input').value;
            const participantCount = parseInt(document.getElementById('participant-count').value);
            const billAmount = parseFloat(form.elements['bill-amount'].value);

            // 1. Gather Data
            const formData = {
                name: form.elements['bill-name'].value,
                amount: billAmount,
                payer: window.userAddress, // Set payer to connected user
                splitType: splitType,
                shares: []
            };
            
            let totalParticipants = participantCount + 1; // Payer + Participants

            // Calculate share amount for all parties (including the payer who may have a share)
            for (let i = 1; i <= participantCount; i++) {
                const address = form.elements[`participant-${i}-address`].value;
                let shareAmount;

                if (splitType === 'even') {
                    // Even split among Payer + Participants
                    shareAmount = parseFloat((billAmount / totalParticipants).toFixed(2));
                } else { // Manual split
                    shareAmount = parseFloat(form.elements[`participant-${i}-share`]?.value || 0);
                }
                
                formData.shares.push({
                    address: address,
                    amount: shareAmount
                });
            }

            // Payer's share is the remaining amount (for manual split) or the even share
            const currentTotalShare = formData.shares.reduce((sum, s) => sum + parseFloat(s.amount), 0);
            const payerShare = billAmount - currentTotalShare;

            formData.shares.push({
                address: window.userAddress,
                amount: payerShare
            });
            
            // 2. Validate Data
            if (!validateForm(formData)) return;
            
            try {
                showMessageBox("Broadcasting Bill...", "Sending transaction to the smart contract. Please confirm in your wallet.", null);

                // LIVE CALL: Assumes sendBillToContract exists in wallet.js
                const tx = await window.sendBillToContract(formData, formData.shares);
                console.log("Transaction sent:", tx);

                // 4. Success Message and Redirection
                showMessageBox("Bill Broadcasted!", 
                            `Your bill "${formData.name}" has been successfully broadcasted. Transaction Hash: ${tx.transaction_hash.substring(0, 10)}... Redirecting to Dashboard...`,
                            () => {
                                form.reset();
                                updateParticipants(0);
                                toggleSplit('even');
                                navigateTo('dashboard');
                            });

            } catch (error) {
                 console.error("Bill Submission Failed:", error);
                 showMessageBox("Transaction Failed", `Could not broadcast the bill. Error: ${error.message || "Unknown error"}`);
            }
        }

        // ====================================================================
        // --- LEADERBOARD LOGIC (Calls wallet.js/contract) ---
        // ====================================================================
        
        window.loadLeaderboard = async function() {
            const container = document.getElementById('leaderboard-list');
            if (!container || !window.fetchLeaderboard) return;

            container.innerHTML = '<div class="text-center p-8 text-primary font-semibold">Fetching live reputation scores...</div>';

            try {
                // LIVE CALL: Assumes fetchLeaderboard exists in wallet.js
                const leaderboardData = await window.fetchLeaderboard(); // Assuming this function exists now
                renderLeaderboardList(leaderboardData);

            } catch (error) {
                console.error("Failed to load leaderboard:", error);
                container.innerHTML = `<div class="text-center p-8 text-red-400">Error loading data. Is the contract connected?</div>`;
            }
        }

        function renderLeaderboardList(data) {
            const container = document.getElementById('leaderboard-list');
            let listHtml = '';
            const userAddress = window.userAddress || "0xUnconnectedUser";
            
            // Mock data structure for rendering if live data fails (optional)
            if (!data || data.length === 0) {
                data = [
                    { address: "0x05f8...1234", score: 9.8, settledRate: 0.98, totalBills: 25 },
                    { address: userAddress, score: 9.5, settledRate: 0.95, totalBills: 12 },
                    { address: "0x0a1c...5678", score: 9.0, settledRate: 0.90, totalBills: 40 },
                ];
            }
            
            data.forEach((player, index) => {
                const rankColor = index === 0 ? 'text-secondary text-2xl' : index === 1 ? 'text-primary/80 text-xl' : index === 2 ? 'text-muted text-lg' : 'text-muted text-base';
                const displayName = player.address === userAddress ? 'You' : player.address.substring(0, 8) + '...';

                const playerRow = `
                    <div class="flex items-center justify-between p-4 bg-card rounded-lg border border-border mb-3 transition hover:border-primary/50">
                        <div class="flex items-center space-x-4 w-1/2">
                            <span class="font-extrabold ${rankColor}">${index + 1}</span>
                            <div class="flex flex-col">
                                <span class="text-foreground font-semibold">${displayName}</span>
                                <span class="text-xs text-muted">Bills: ${player.totalBills || 0}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xl font-bold text-primary">${(player.score || 0).toFixed(1)}</span>
                            <div class="text-xs text-muted">Settled Rate: ${((player.settledRate || 0) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                `;
                listHtml += playerRow;
            });
            
            container.innerHTML = listHtml;
        }


        // ====================================================================
        // --- INITIALIZATION ---
        // ====================================================================

        function setupInitialUI() {
            // Set up form and navigation state
            toggleSplit('even'); 
            updateParticipants(0); // Start with 0 participants
            
            // Event listeners
            document.getElementById('bill-form').addEventListener('submit', function(e) { 
                e.preventDefault(); 
                submitBill(); 
            });

            document.getElementById('menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            // Start the application on the Dashboard page
            navigateTo('dashboard');
        }

        document.addEventListener('DOMContentLoaded', setupInitialUI);
    </script>
    
    </head>
<body class="bg-background min-h-screen text-foreground antialiased overflow-x-hidden">

    <div id="message-box" class="hidden fixed inset-0 z-50 bg-background/80 backdrop-blur-sm items-center justify-center p-4">
        </div>
    
    <nav class="sticky top-0 z-40 bg-background/90 backdrop-blur-md border-b border-border shadow-lg">
        </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        </main>

    <script type="module">
        import { getStarknet } from 'https://cdn.jsdelivr.net/npm/@starknet-io/get-starknet@latest/dist/index.js';
        
        // Expose the necessary function globally
        window.getStarknet = getStarknet; 
        
        // Auto-connect on load (must be placed after all functions are defined)
        document.addEventListener('DOMContentLoaded', () => {
            // The wallet object is still injected into window.starknet by the extension
            if (window.starknet && window.starknet.isConnected) {
                // Call the connectWallet function exposed in the wallet.js module
                if (typeof window.connectWallet === 'function') {
                    window.connectWallet().catch(console.error);
                }
            }
        });
    </script>
    
    <script type="module" src="wallet.js"></script> 
    
</body>
</html>