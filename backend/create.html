<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitMate - Create Bill</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/wallet.js"></script> 
    
    <script>
        // --- Tailwind Configuration (UI Theme) ---
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                background: "#10002b",
                card: { DEFAULT: "transparent", foreground: "hsl(210 40% 98%)" },
                primary: {
                  DEFAULT: "#c77dff", // Bright Electric Purple
                  active: "#7400b8", // Deep Purple for Button Fill
                  foreground: "hsl(210 40% 98%)",
                },
                secondary: {
                  DEFAULT: "#ff9e00", // Vibrant Orange
                  foreground: "hsl(210 40% 98%)",
                },
                success: { // Added for Bitcoin Sponsor button 
                  DEFAULT: "#4cd964",
                  foreground: "hsl(210 40% 98%)",
                },
                muted: {
                  DEFAULT: "hsl(260 20% 40%)",
                  foreground: "hsl(260 20% 50%)",
                },
                border: "hsl(260 20% 25%)", 
                input: "hsl(260 20% 25%)",
                ring: "hsl(260 20% 25%)",
                foreground: "hsl(210 40% 98%)",
              },
              // Animation for participant list
              animation: {
                'fade-in': 'fadeIn 0.5s ease-out forwards',
              },
              keyframes: {
                fadeIn: {
                  '0%': { opacity: '0', transform: 'translateY(-10px)' },
                  '100%': { opacity: '1', transform: 'translateY(0)' },
                }
              }
            },
          },
        }
    </script>
    <style>
        .form-input {
            @apply flex h-10 w-full rounded-md border border-input bg-card-foreground/5 px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50;
        }
        .active {
            @apply bg-primary-active text-foreground font-semibold;
        }
        .inactive {
            @apply border border-primary text-primary hover:bg-primary-active/20;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
            opacity: 0;
        }
        .manual-share-input-container {
            @apply flex items-center bg-card-foreground/5 rounded-md border border-input;
        }
        .manual-share-input {
            @apply flex h-10 w-full bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none disabled:cursor-not-allowed disabled:opacity-50;
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .manual-currency-text {
             @apply text-sm text-muted-foreground px-3;
        }
    </style>

</head>
<body class="min-h-screen bg-background text-foreground flex flex-col font-sans">
    
    <header class="bg-card/50 backdrop-blur-sm sticky top-0 z-50 border-b border-border">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">
                <a href="index.html">SplitMate</a>
            </h1>
            
            <nav class="hidden md:flex space-x-6 items-center">
                <a href="index.html" class="text-sm font-medium hover:text-primary transition-colors">Dashboard</a>
                <a href="create.html" class="text-sm font-medium text-primary border-b-2 border-primary pb-1">Create Bill</a>
                <a href="leaderboard.html" class="text-sm font-medium hover:text-primary transition-colors">Leaderboard</a>
                
                <button id="wallet-button" onclick="openConnectModal()" 
                    class="ml-4 px-4 py-2 rounded-lg bg-primary text-background text-sm font-semibold hover:bg-primary-active transition duration-200">
                    Connect Wallet
                </button>
            </nav>

            <button id="menu-toggle" class="md:hidden text-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>

        <nav id="mobile-menu" class="hidden md:hidden px-4 pt-2 pb-4 space-y-2 bg-card/50 border-t border-border">
            <a href="index.html" class="block text-sm font-medium hover:text-primary transition-colors">Dashboard</a>
            <a href="create.html" class="block text-sm font-medium text-primary">Create Bill</a>
            <a href="leaderboard.html" class="block text-sm font-medium hover:text-primary transition-colors">Leaderboard</a>
            <button id="mobile-wallet-button" onclick="openConnectModal()" 
                class="w-full text-left px-4 py-2 rounded-lg bg-primary text-background text-sm font-semibold hover:bg-primary-active transition duration-200 mt-2">
                Connect Wallet
            </button>
        </nav>
    </header>

    <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <h2 class="text-3xl font-bold text-foreground mb-6">Create New Bill</h2>
        <p class="text-muted-foreground mb-8">Split a bill with friends and broadcast the payment request on-chain.</p>

        <form id="bill-form" class="space-y-6">
            
            <div class="p-4 rounded-lg border border-border bg-card-foreground/5">
                <p id="creator-address-display" class="font-semibold text-primary">
                    Please connect your wallet to set the bill creator address.
                </p>
                <p id="connect-status-message" class="text-sm text-secondary mt-1">
                    Connect your wallet to enable bill creation.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label class="block space-y-1">
                    <span class="text-sm font-medium text-muted-foreground">Bill Name</span>
                    <input type="text" id="bill-name" placeholder="Dinner with Friends" required class="form-input">
                </label>
                <label class="block space-y-1">
                    <span class="text-sm font-medium text-muted-foreground">Merchant Wallet Address (Optional)</span>
                    <input type="text" id="merchant-address" placeholder="0x..." class="form-input">
                </label>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <label class="block space-y-1">
                    <span class="text-sm font-medium text-muted-foreground">Total Amount</span>
                    <input type="number" step="0.01" id="total-amount" oninput="updateCalculations()" placeholder="100.00" required class="form-input" min="0">
                </label>
                <label class="block space-y-1">
                    <span class="text-sm font-medium text-muted-foreground">Token</span>
                    <select id="bill-token" onchange="updateCalculations()" class="form-input">
                        <option value="USDC">USDC</option>
                        <option value="ETH">ETH</option>
                        <option value="DAI">DAI</option>
                    </select>
                </label>
            </div>

            <div class="space-y-4 p-4 rounded-lg border border-border bg-card-foreground/5">
                <h3 class="text-xl font-semibold mb-3">Participants</h3>
                <p class="text-sm text-muted-foreground">Add wallet addresses for the people you are splitting the bill with (excluding yourself).</p>

                <div class="flex items-center space-x-4">
                    <button type="button" id="minus-btn" onclick="updateParticipants(-1)" disabled
                        class="px-3 py-1 bg-muted-foreground/20 rounded-md text-foreground font-bold hover:bg-muted-foreground/30 transition duration-150 disabled:opacity-50"
                        title="Remove Participant">
                        -
                    </button>
                    <span class="text-xl font-bold" id="participant-count">0</span>
                    <button type="button" id="plus-btn" onclick="updateParticipants(1)"
                        class="px-3 py-1 bg-primary rounded-md text-background font-bold hover:bg-primary-active transition duration-150"
                        title="Add Participant">
                        +
                    </button>
                </div>
                
                <div id="participant-addresses" class="space-y-4 mt-4">
                    </div>
            </div>

            <div class="space-y-4 p-4 rounded-lg border border-border bg-card-foreground/5">
                <h3 class="text-xl font-semibold mb-3">Split Method</h3>
                <div class="flex space-x-4">
                    <button type="button" id="btn-even" onclick="toggleSplit('even')" class="flex-1 py-2 px-4 rounded-lg transition duration-200">
                        Split Evenly
                    </button>
                    <button type="button" id="btn-manual" onclick="toggleSplit('manual')" class="flex-1 py-2 px-4 rounded-lg transition duration-200">
                        Manual Split
                    </button>
                </div>

                <div id="split-even-content">
                    <p class="text-muted-foreground mb-2">Each of the <span id="even-participants" class="font-bold text-primary">1</span> people pays:</p>
                    <div class="text-2xl font-bold text-secondary">
                        <span id="split-result">0.00 USDC</span>
                    </div>
                </div>

                <div id="split-manual-content" class="hidden">
                    <p class="text-muted-foreground mb-4">Define the exact amount each person must pay.</p>
                    
                    <div id="manual-participants-list" class="space-y-4">
                        </div>

                    <div id="manual-validation-box" class="mt-4 p-3 rounded-lg border border-border">
                        <div class="flex justify-between items-center text-sm font-medium">
                            <span class="text-muted-foreground">Total Remaining to Assign</span>
                            <span id="manual-remaining" class="font-bold text-secondary">0.00 USDC</span>
                        </div>
                        <p id="validation-message" class="text-xs text-red-500 mt-1 hidden">Total assigned shares must exactly match the Bill Amount.</p>
                    </div>
                </div>
            </div>
            
            <label class="block space-y-1">
                <span class="text-sm font-medium text-muted-foreground">Notes (Optional)</span>
                <textarea id="bill-note" rows="2" placeholder="Specific items to exclude or payment instructions." class="form-input"></textarea>
            </label>

            <div class="pt-4">
                <button type="submit" id="submit-button" disabled
                    class="w-full py-3 bg-primary text-background font-semibold rounded-lg hover:bg-primary-active transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Broadcast Bill on Chain
                </button>
            </div>
             <div class="pt-2">
                <button type="button" 
                    onclick="window.sponsorBillWithInscription({id: 'BILL_' + Date.now(), name: document.getElementById('bill-name').value})"
                    class="w-full py-3 bg-success text-background font-semibold rounded-lg hover:bg-success/80 transition duration-200">
                    Sponsor this Bill (Bitcoin Utility)
                </button>
            </div>

        </form>

    </main>
    
    <div id="connect-wallet-modal" class="fixed inset-0 bg-background/90 backdrop-blur-sm z-50 hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-card/90 border border-primary p-6 rounded-xl shadow-2xl w-full max-w-sm relative">
            <button onclick="closeConnectModal()" class="absolute top-4 right-4 text-foreground hover:text-primary transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <h3 class="text-2xl font-bold text-primary mb-4">Connect Wallet</h3>
            <p class="text-sm text-muted-foreground mb-6">Choose your preferred network and wallet.</p>

            <div class="space-y-4">
                <button onclick="window.connectMetamaskWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="w-6 h-6 mr-3">
                    MetaMask (EVM)
                </button>
                <button onclick="window.connectStarknetWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://starkware.co/wp-content/uploads/2021/07/starknet-logo.svg" alt="Starknet" class="w-6 h-6 mr-3">
                    Starknet (ArgentX/Braavos)
                </button>
                <button onclick="window.connectXverseWallet()" class="w-full flex items-center justify-center p-3 border border-border rounded-lg hover:bg-primary/10 transition duration-200">
                    <img src="https://www.xverse.app/img/logo.svg" alt="Xverse" class="w-6 h-6 mr-3">
                    Bitcoin / Sponsor
                </button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed inset-0 bg-background/90 backdrop-blur-sm z-[60] hidden items-center justify-center transition-opacity duration-300">
        <div class="bg-card/90 border border-primary p-6 rounded-xl shadow-2xl w-full max-w-sm relative text-center">
            <h3 id="message-title" class="text-xl font-bold text-primary mb-3"></h3>
            <p id="message-content" class="text-sm text-muted-foreground mb-6"></p>
            <button onclick="closeMessageBox()" class="w-full py-2 bg-primary text-background font-semibold rounded-lg hover:bg-primary-active transition duration-200">
                OK
            </button>
        </div>
    </div>


    <script>
        // --- Globals ---
        let participantCount = 0; // External participants (excluding Creator)
        let splitType = 'even'; // Default split type
        
        // --- Utility Functions: SHARED ACROSS PAGES ---
        // (Format address is defined in wallet.js, but kept here for local context)
        function formatAddress(address, chars = 6) {
            if (!address || address.length < chars * 2 + 3) return address;
            return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
        }

        // --- Utility Functions: CONNECT MODAL (CRITICAL FIX: These must be defined for the header button) ---
        function openConnectModal() {
            const modal = document.getElementById('connect-wallet-modal'); 
            if (modal) {
                 modal.classList.remove('hidden');
                 modal.classList.add('flex');
            }
        }

        function closeConnectModal() {
            const modal = document.getElementById('connect-wallet-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // --- Utility Functions: MESSAGE BOX ---
        // (These must be defined locally as they interact with the message-box HTML)
        function showMessageBox(title, content, onOk = null) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-content').innerHTML = content;
            const okButton = document.querySelector('#message-box button');
            
            okButton.onclick = null; 
            
            okButton.onclick = () => {
                closeMessageBox();
                if (typeof onOk === 'function') {
                    onOk();
                }
            };

            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('message-box').classList.add('flex');
        }

        function closeMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }

        // --- Wallet Integration (Called by wallet.js) ---
        // CRITICAL FIX: This function updates the header button and form status on page load/wallet change.
        window.loadPageContent = async function(address) { 
            const submitBtn = document.getElementById('submit-button');
            const creatorDisplay = document.getElementById('creator-address-display');
            const statusMessage = document.getElementById('connect-status-message');
            const walletButton = document.getElementById('wallet-button'); // The Desktop Header Button
            const mobileWalletButton = document.getElementById('mobile-wallet-button'); // The Mobile Header Button

            const isConnected = !!window.userAddress; 

            if (isConnected) {
                // 1. HEADER BUTTON UPDATE (FIXES DISCONNECT APPEARANCE)
                const buttonText = `Disconnect (${formatAddress(window.userAddress, 4)})`;
                walletButton.textContent = buttonText;
                mobileWalletButton.textContent = buttonText;
                
                walletButton.onclick = window.disconnectWallet; 
                mobileWalletButton.onclick = window.disconnectWallet; 

                // 2. FORM DISPLAY
                creatorDisplay.textContent = 'Bill Creator: ' + formatAddress(window.userAddress);
                statusMessage.classList.add('hidden');
                
                // Re-evaluate the submit button state based on connection and current calculation
                updateCalculations();
            } else {
                // 1. HEADER BUTTON UPDATE
                walletButton.textContent = 'Connect Wallet';
                mobileWalletButton.textContent = 'Connect Wallet';
                walletButton.onclick = openConnectModal;
                mobileWalletButton.onclick = openConnectModal;


                // 2. FORM DISPLAY
                creatorDisplay.textContent = 'Please connect your wallet to set the bill creator address.';
                statusMessage.textContent = 'Connect your wallet to enable bill creation.';
                statusMessage.classList.remove('hidden');

                // The submit button is explicitly disabled if not connected
                submitBtn.disabled = true;
            }
            // Ensure address is updated in manual split UI if active
            if (splitType === 'manual') {
                generateManualInputs();
            }
        }
        
        function getFormData() {
            const totalAmountStr = document.getElementById('total-amount').value;
            const totalAmount = parseFloat(totalAmountStr);
            const token = document.getElementById('bill-token').value;
            
            const participantAddressInputs = document.querySelectorAll('.participant-address-input');
            const nonCreatorParticipants = Array.from(participantAddressInputs).map(input => input.value.trim());

            return {
                name: document.getElementById('bill-name').value.trim(),
                amount: isNaN(totalAmount) ? 0 : totalAmount,
                token: token,
                merchantAddress: document.getElementById('merchant-address').value.trim(),
                creatorAddress: window.userAddress || "0x(Not Connected)", 
                note: document.getElementById('bill-note').value.trim(),
                splitType: splitType,
                participants: nonCreatorParticipants,
                totalCount: nonCreatorParticipants.length + 1, // Creator + Participants
            };
        }

        // --- Core Logic: Participants and Addresses ---

        function generateAddressInputs() {
            const container = document.getElementById('participant-addresses');
            const existingInputs = document.querySelectorAll('.participant-address-input');
            const existingValues = Array.from(existingInputs).map(input => input.value);

            container.innerHTML = ''; 

            for (let i = 0; i < participantCount; i++) {
                const value = existingValues[i] || '';
                const inputHtml = `
                    <label class="block space-y-1 fade-in" style="animation-delay: ${i * 0.05}s;">
                        <span class="text-sm font-medium text-muted-foreground">Participant ${i + 1} Wallet Address</span>
                        <input type="text" value="${value}" placeholder="0x..." required
                                class="participant-address-input form-input text-sm w-full"
                                oninput="updateCalculations()"> 
                    </label>
                `;
                container.insertAdjacentHTML('beforeend', inputHtml);
            }
        }

        function updateParticipants(change) {
            const minusBtn = document.getElementById('minus-btn');
            const plusBtn = document.getElementById('plus-btn');

            let newCount = participantCount + change; 
            
            if (newCount > 10) { 
                showMessageBox("Limit Reached", "The maximum number of participants (excluding the Creator) is 10.");
                newCount = 10;
            }

            // Ensure count doesn't go below 0
            participantCount = Math.max(0, newCount); 
            
            // Update button states (always enabled but visually disabled if at limit/zero)
            if (minusBtn) minusBtn.disabled = participantCount === 0;
            if (plusBtn) plusBtn.disabled = participantCount === 10;
            

            document.getElementById('participant-count').textContent = participantCount;
            // Display total people (Creator + Participants)
            document.getElementById('even-participants').textContent = participantCount + 1; 
            
            generateAddressInputs();
            updateCalculations();
        }


        // --- Core Logic: Splitting and Validation ---
        
        function isManualSplitValid() {
            const formData = getFormData();
            const inputs = document.querySelectorAll('.manual-share-input'); 
            let totalAssigned = 0;

            inputs.forEach(input => {
                totalAssigned += parseFloat(input.value) || 0;
            });
            
            // Use Math.abs and a small epsilon (0.01) for robust float comparison
            return Math.abs(formData.amount - totalAssigned) < 0.01;
        }

        function updateCalculations() {
            const submitBtn = document.getElementById('submit-button');
            const totalAmount = parseFloat(document.getElementById('total-amount').value) || 0;
            let isValid = false;
            
            // 1. Update split display and calculate validation state
            if (splitType === 'manual') {
                generateManualInputs(); 
                calculateManualRemaining(); 
                isValid = isManualSplitValid();
            } else {
                calculateEvenSplit();
                // Even split is valid if the total amount is entered (> 0)
                isValid = totalAmount > 0;
            }
            
            // 2. Control the submit button based on all conditions
            const requiredFields = ['bill-name', 'total-amount', 'merchant-address'];
            const allFieldsFilled = requiredFields.every(id => document.getElementById(id).value.trim() !== '');

            // All participant address inputs must also be filled if they exist
            const participantInputs = document.querySelectorAll('.participant-address-input');
            const allParticipantsFilled = Array.from(participantInputs).every(input => input.value.trim() !== '');
            
            // New check: We need at least one other participant to "split" a bill
            const hasParticipants = participantCount > 0;

            if (window.userAddress && isValid && allFieldsFilled && allParticipantsFilled && hasParticipants) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function calculateEvenSplit() {
            const totalAmount = parseFloat(document.getElementById('total-amount').value) || 0;
            const token = document.getElementById('bill-token').value;
            const totalPeople = participantCount + 1; 
            
            let displayAmount = 0.00;
            if (totalAmount > 0 && totalPeople > 0) {
                // Calculation is correct for display: just divide and format
                displayAmount = totalAmount / totalPeople;
            }
            
            document.getElementById('split-result').textContent = `${displayAmount.toFixed(2)} ${token}`;
        }

        function generateManualInputs() {
            const list = document.getElementById('manual-participants-list');
            
            const existingManualInputs = document.querySelectorAll('.manual-share-input');
            const existingValuesMap = {};
            existingManualInputs.forEach(input => {
                existingValuesMap[input.id] = input.value;
            });
            
            list.innerHTML = '';
            const formData = getFormData();
            
            const participantAddressInputs = document.querySelectorAll('.participant-address-input');
            
            const creatorDisplayAddress = window.userAddress ? formatAddress(window.userAddress, 6) : "0x(Connect Wallet)";

            const allSplitters = [
                { address: formData.creatorAddress, label: `Creator's Share (${creatorDisplayAddress})`, inputId: 'creator-manual-share' }
            ].concat(
                Array.from(participantAddressInputs).map((input, i) => ({ 
                    address: input.value.trim(), 
                    label: `Participant ${i + 1} Share (${formatAddress(input.value.trim(), 6)})`,
                    inputId: `participant-${i + 1}-manual-share`
                }))
            );

            allSplitters.forEach((splitter, i) => {
                const baseValue = existingValuesMap[splitter.inputId] || '0.00';
                
                const inputHtml = `
                    <label class="block space-y-1 fade-in" style="animation-delay: ${i * 0.05}s;">
                        <span class="text-sm font-medium text-muted-foreground">${splitter.label}</span>
                        <div class="manual-share-input-container">
                            <input type="number" step="0.01" id="${splitter.inputId}" value="${baseValue}" 
                                    oninput="updateCalculations()" required
                                    class="manual-share-input" min="0">
                            <span class="manual-currency-text">${formData.token}</span>
                        </div>
                    </label>
                `;
                list.insertAdjacentHTML('beforeend', inputHtml);
            });
        }

        function calculateManualRemaining() {
            const formData = getFormData();
            const inputs = document.querySelectorAll('.manual-share-input'); 
            let totalAssigned = 0;

            inputs.forEach(input => {
                totalAssigned += parseFloat(input.value) || 0;
            });

            const remaining = (formData.amount - totalAssigned);
            
            const remainingText = document.getElementById('manual-remaining');
            // Use Math.abs for display, but check if it's over or under
            remainingText.textContent = `${Math.abs(remaining).toFixed(2)} ${formData.token}`;
            
            const validationBox = document.getElementById('manual-validation-box');
            const validationMsg = document.getElementById('validation-message');
            
            // Check if the remaining amount is within 1 cent (robust check for float math) and total amount is set
            const fullyAssigned = Math.abs(remaining) < 0.01 && formData.amount > 0; 

            // Update styles and validation message
            remainingText.classList.remove('text-red-500', 'text-green-500', 'text-secondary');
            validationBox.classList.remove('border-red-500', 'border-green-500');
            validationMsg.classList.add('hidden');
            
            if (fullyAssigned) {
                remainingText.classList.add('text-green-500');
                validationBox.classList.add('border-green-500');
                remainingText.previousElementSibling.textContent = 'Perfectly Assigned';
            } else {
                remainingText.classList.add('text-red-500');
                validationBox.classList.add('border-red-500');
                remainingText.previousElementSibling.textContent = remaining > 0 ? 'Total Remaining to Assign' : 'Total Over-Assigned';
                validationMsg.classList.remove('hidden');
            }
        }

        function toggleSplit(type) {
            splitType = type;
            const btnEven = document.getElementById('btn-even');
            const btnManual = document.getElementById('btn-manual');
            const contentEven = document.getElementById('split-even-content');
            const contentManual = document.getElementById('split-manual-content');

            btnEven.classList.remove('active', 'inactive');
            btnManual.classList.remove('active', 'inactive');
            
            if (type === 'even') {
                btnEven.classList.add('active');
                btnManual.classList.add('inactive'); 
                contentEven.classList.remove('hidden');
                contentManual.classList.add('hidden');
            } else {
                btnManual.classList.add('active');
                btnEven.classList.add('inactive'); 
                contentManual.classList.remove('hidden');
                contentEven.classList.add('hidden');
            }
            updateCalculations(); 
        }
        
        // --- Submission Logic (COMPLETED) ---
        function submitBill() {
            console.log("Submit button clicked and function running."); 

            // 1. Form Validation Check
            if (!document.getElementById('bill-form').checkValidity()) {
                showMessageBox("Input Error", "Please fill out all required fields. Check Bill Name, Amount, Merchant, and Participant Addresses.");
                return;
            }

            // 2. Wallet Connection Check
            if (!window.userAddress) {
                showMessageBox("Wallet Required", "You must connect your wallet to submit a bill.");
                return;
            }
            
            // 3. Logic Execution
            const formData = getFormData();
            let shares = [];
            const allSplitters = [window.userAddress].concat(formData.participants); 

            if (formData.splitType === 'even') {
                const totalCents = Math.round(formData.amount * 100); 
                const totalSplitters = allSplitters.length;

                if (totalSplitters === 0 || totalCents === 0) {
                     showMessageBox("Validation Error", "The bill amount must be greater than 0 and there must be at least one other participant.");
                     return;
                }
                
                const baseShareCents = Math.floor(totalCents / totalSplitters);
                let remainderCents = totalCents % totalSplitters; 
                
                shares = [];
                for (let i = 0; i < totalSplitters; i++) {
                    let share = baseShareCents;
                    if (remainderCents > 0) {
                        share += 1; 
                        remainderCents--;
                    }
                    shares.push(parseFloat((share / 100).toFixed(2))); 
                }

            } else { 
                if (!isManualSplitValid()) {
                     showMessageBox("Validation Error", "Manual shares must exactly match the Total Bill Amount (within 1 cent tolerance).");
                     return;
                }
                const shareInputs = document.querySelectorAll('.manual-share-input');
                shares.push(parseFloat(document.getElementById('creator-manual-share').value) || 0);
                for (let i = 1; i <= formData.participants.length; i++) {
                    shares.push(parseFloat(document.getElementById(`participant-${i}-manual-share`).value) || 0);
                }
            }
            
            const uniqueId = `bill_${Date.now()}`; 

            const transactionPayload = {
                id: uniqueId, 
                contractCall: "createBill",
                creator: window.userAddress, 
                merchant: formData.merchantAddress,
                billName: formData.name,
                token: formData.token, 
                totalAmount: formData.amount,
                participants: allSplitters, 
                shares: shares, 
                note: formData.note,
                isSettled: false,
            };
            
            console.log("--- SIMULATED BLOCKCHAIN TRANSACTION PAYLOAD ---");
            console.log(JSON.stringify(transactionPayload, null, 2));
            
            // *** NEW: SAVE TO LOCAL STORAGE (Simulates On-Chain Recording) ***
            let bills = JSON.parse(localStorage.getItem('bills') || '[]');
            bills.push(transactionPayload);
            localStorage.setItem('bills', JSON.stringify(bills));
            
            // 4. Success Message and Redirection
            showMessageBox("Bill Broadcasted!", 
                           `Your bill "${formData.name}" has been successfully broadcasted to the SplitMate contract. Redirecting to Dashboard...`,
                           () => {
                               window.location.href = 'index.html';
                           });
        }
        
        // --- Initialization ---

        function setupInitialUI() {
            toggleSplit('even');
            updateParticipants(0); 

            document.getElementById('bill-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitBill();
            });

            document.getElementById('menu-toggle').addEventListener('click', function() {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            setupInitialUI();
            // wallet.js handles the initial call to window.loadPageContent(address) 
        });
    </script>
</body>
</html>